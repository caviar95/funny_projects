C++ ä¸­çš„ Lambdaï¼ˆåŒ¿åå‡½æ•°ï¼‰æ˜¯ç°ä»£ C++ï¼ˆè‡ª C++11 èµ·ï¼‰éå¸¸é‡è¦çš„ç‰¹æ€§ä¹‹ä¸€ï¼Œåœ¨å¤šçº¿ç¨‹ã€STLã€å›è°ƒã€å‡½æ•°å¯¹è±¡ç­‰åœºæ™¯ä¸­æå…¶å¸¸ç”¨ã€‚

---

## âœ… ä¸€ã€Lambda åŸºç¡€è¯­æ³•

### åŸºæœ¬å½¢å¼ï¼š

```cpp
[capture](parameters) mutable specifiers -> return_type {
    // function body
};
```

### ç¤ºä¾‹ï¼š

```cpp
auto f = [](int a, int b) -> int { // ä¹Ÿå±äºåŒ¿åï¼ï¼ï¼
    return a + b;
};
std::cout << f(3, 4);  // è¾“å‡º 7
```

---

## âœ… äºŒã€å„ç»„æˆéƒ¨åˆ†è¯¦è§£

| ç»„æˆéƒ¨åˆ†           | è¯´æ˜                                                     |
| -------------- | ------------------------------------------------------ |
| `[capture]`    | æ•è·å¤–éƒ¨å˜é‡ï¼ˆby value / by referenceï¼‰                        |
| `(parameters)` | å‚æ•°åˆ—è¡¨                                                   |
| `mutable`      | å…è®¸ä¿®æ”¹æŒ‰å€¼æ•è·çš„å˜é‡                                            |
| `specifiers`   | å¦‚ `constexpr`, `noexcept`, `mutable`, `-> return_type` |
| `return_type`  | è¿”å›ç±»å‹ï¼ˆå¯çœç•¥ï¼Œç¼–è¯‘å™¨è‡ªåŠ¨æ¨å¯¼ï¼‰                                      |
| `{}`           | å‡½æ•°ä½“                                                    |

---

## âœ… ä¸‰ã€å¸¸è§æ•è·æ–¹å¼

```cpp
int x = 10, y = 20;

auto a = [x, &y]() { std::cout << x << " " << y << "\n"; };  // xå€¼æ‹·è´, yå¼•ç”¨
auto b = [&]() { x++; y++; };          // æ‰€æœ‰å˜é‡å¼•ç”¨æ•è·
auto c = [=]() { return x + y; };      // æ‰€æœ‰å˜é‡å€¼æ•è·
auto d = [=, &y]() { return x + y; };  // é»˜è®¤å€¼æ•è·ï¼Œyä¸ºå¼•ç”¨
auto e = [&, x]() { return x + y; };   // é»˜è®¤å¼•ç”¨æ•è·ï¼Œxä¸ºå€¼
```

---

## âœ… å››ã€Lambda ä½¿ç”¨åœºæ™¯

### âœ… 1. STL ç®—æ³•ï¼š

```cpp
std::vector<int> v = {1, 2, 3, 4};
std::for_each(v.begin(), v.end(), [](int x) {
    std::cout << x << " ";
});
```

### âœ… 2. å¤šçº¿ç¨‹å‡½æ•°ï¼ˆå¦‚ std::threadï¼‰ï¼š

```cpp
std::thread t([](int id) {
    std::cout << "Thread " << id;
}, 1);
t.join();
```

### âœ… 3. è‡ªå®šä¹‰æ’åºè§„åˆ™ï¼š

```cpp
std::sort(v.begin(), v.end(), [](int a, int b) {
    return a > b;
});
```

### âœ… 4. å›è°ƒï¼ˆå¦‚ GUI ç¼–ç¨‹ï¼‰ï¼š

```cpp
registerCallback([](Event e) {
    handleEvent(e);
});
```

### âœ… 5. å°è£…ä¸€æ¬¡æ€§é€»è¾‘ï¼Œå‡å°‘å‡½æ•°æ±¡æŸ“ï¼š

```cpp
auto result = [&]() {
    if (cond) return 1;
    else return 2;
}();
```

---

## âœ… äº”ã€Lambda é«˜çº§ç‰¹æ€§

### âœ… 1. `mutable` ç”¨æ³•

```cpp
int x = 10;
auto f = [x]() mutable {
    x++;
    std::cout << x;  // æ”¹å˜çš„æ˜¯æ•è·å‰¯æœ¬
};
```

### âœ… 2. æŒ‡å®šè¿”å›ç±»å‹

```cpp
auto f = [](int x) -> double {
    return x / 2.0;
};
```

### âœ… 3. æ³›å‹ Lambdaï¼ˆC++14 èµ·ï¼‰

```cpp
auto f = [](auto x, auto y) {
    return x + y;
};
f(1, 2); f(1.1, 2.2); f("a"s, "b"s);
```

### âœ… 4. æ•è·ç»“æ„åŒ–ç»‘å®šï¼ˆC++20ï¼‰

```cpp
std::pair<int, int> p = {1, 2};
auto f = [a = p.first, b = p.second]() {
    std::cout << a + b;
};
```

---

## âš ï¸ å…­ã€å¸¸è§ Lambda è¯¯ç”¨åœºæ™¯å’Œéšæ‚£

### âŒ 1. ä½¿ç”¨äº†æ‚¬ç©ºå¼•ç”¨

```cpp
auto makeLambda() {
    int x = 42;
    return [&]() { return x; };  // é”™è¯¯ï¼šxä¼šæ‚¬ç©º
}
auto f = makeLambda();  // f ä¸­çš„å¼•ç”¨æŒ‡å‘å·²é‡Šæ”¾æ ˆç©ºé—´
```

âœ… è§£å†³ï¼šç”¨å€¼æ•è· `[x]` è€Œä¸æ˜¯ `[&x]`

---

### âŒ 2. æŒ‰å€¼æ•è·ï¼Œä½†æœŸæœ›å…¶è¢«ä¿®æ”¹ï¼ˆå¿˜è®° mutableï¼‰

```cpp
int x = 10;
auto f = [x]() {
    x++;
};  // ç¼–è¯‘å¤±è´¥
```

âœ… ä¿®å¤ï¼š

```cpp
auto f = [x]() mutable { x++; };
```

---

### âŒ 3. æ•è·æ•°ç»„æˆ– new å‡ºæ¥çš„æŒ‡é’ˆï¼Œå¯¼è‡´æ‚¬ç©ºæˆ–å†…å­˜æ³„éœ²

```cpp
int* p = new int(5);
auto f = [p]() { std::cout << *p; };
// delete p; // f ä¸­ p æˆä¸ºæ‚¬ç©ºæŒ‡é’ˆ
```

âœ… ä¿®å¤ï¼šä½¿ç”¨ `shared_ptr` æˆ–æ˜ç¡®çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†

---

### âŒ 4. Lambda å¤ªå¤æ‚å¯¼è‡´éš¾ä»¥ç»´æŠ¤

```cpp
std::function<void()> f = [a, b, c, d, e, f, g, h]() {
    // å¤æ‚é€»è¾‘
};
```

âœ… å»ºè®®æŠ½å‡½æ•°ï¼Œæˆ–é™åˆ¶é€»è¾‘ç²’åº¦

---

### âŒ 5. Lambda ç”¨ä½œå›è°ƒåç”Ÿå‘½å‘¨æœŸé—®é¢˜

```cpp
void register_cb(std::function<void()> f);
{
    int x = 1;
    register_cb([&]() { std::cout << x; });  // x ç”Ÿå‘½å‘¨æœŸç»“æŸåä»è¢«è®¿é—®
}
```

âœ… ä½¿ç”¨ `std::bind`, `shared_ptr` ç­‰ç®¡ç†å¼•ç”¨å¯¹è±¡ç”Ÿå‘½å‘¨æœŸ

---

### âŒ 6. è¯¯ç”¨æ³›å‹ lambda å¼•å‘æ¨¡æ¿è†¨èƒ€ã€æ„å»ºé€Ÿåº¦å˜æ…¢ï¼ˆC++14 èµ·ï¼‰

æ³›å‹ Lambda ä¼šä¸ºæ¯ç§å‚æ•°ç”Ÿæˆä¸åŒå®ä¾‹ï¼Œå»ºè®®åªåœ¨å¿…è¦åœºæ™¯ä½¿ç”¨ã€‚

---

## âœ… ä¸ƒã€ä¸å‡½æ•°å¯¹è±¡ / `std::function` é…åˆ

### ç¤ºä¾‹ï¼š

```cpp
std::function<int(int, int)> f = [](int a, int b) { return a + b; };
```

âš ï¸ æ³¨æ„ï¼š`std::function` æœ‰ç±»å‹æ“¦é™¤æˆæœ¬ï¼Œé¢‘ç¹ä½¿ç”¨åœ¨é«˜æ€§èƒ½åœºæ™¯ä¸­éœ€è°¨æ…ã€‚

---

## âœ… å…«ã€lambda å¯ä½œä¸ºç±»çš„æˆå‘˜å˜é‡ï¼ˆC++11 èµ·ï¼‰

```cpp
class Worker {
    std::function<void()> task = []() {
        std::cout << "Run\n";
    };
};
```

---

## âœ… ä¹ã€lambda é€’å½’ï¼ˆéœ€è¦ `auto&` æˆ– `std::function`ï¼‰

```cpp
std::function<int(int)> fib = [&](int n) {
    return (n <= 2) ? 1 : fib(n - 1) + fib(n - 2);
};
```

---

## âœ… åã€æ•è· this æŒ‡é’ˆçš„é™·é˜±

```cpp
class Foo {
    int x = 10;
    void func() {
        auto f = [this]() {
            std::cout << x;
        };
    }
};
```

âš ï¸ è‹¥å¯¹è±¡é”€æ¯åå†è°ƒç”¨è¯¥ lambdaï¼Œå°†è®¿é—®æ‚¬ç©º this æŒ‡é’ˆã€‚

âœ… å¯ç”¨ `[=, self = shared_from_this()]` é¿å… this æ‚¬ç©ºã€‚

---

## ğŸ§  æ€»ç»“ä¸€å¼ è¡¨ï¼šLambda å¿«é€Ÿå‚è€ƒ

| ç‰¹æ€§         | ç¤ºä¾‹                            | è¦ç‚¹è¯´æ˜         |
| ---------- | ----------------------------- | ------------ |
| å€¼æ•è·        | `[x]`                         | æ‹·è´å‰¯æœ¬         |
| å¼•ç”¨æ•è·       | `[&x]`                        | å¼•ç”¨åŸå˜é‡ï¼Œæ³¨æ„ç”Ÿå‘½å‘¨æœŸ |
| é»˜è®¤å€¼æ•è·      | `[=]`, `[&]`                  | æ‰€æœ‰å˜é‡å€¼/å¼•ç”¨     |
| mutable    | `[x]() mutable { x++; }`      | å…è®¸ä¿®æ”¹æ‹·è´å‰¯æœ¬     |
| æŒ‡å®šè¿”å›å€¼      | `-> int`                      | æ‰‹åŠ¨æŒ‡å®šå¤æ‚è¿”å›ç±»å‹   |
| æ³›å‹ lambda  | `[](auto a){}`                | C++14 èµ·æ”¯æŒ    |
| ç»“æ„åŒ–ç»‘å®šæ•è·    | `[x = pair.first]`            | C++20        |
| æ•è· this æˆå‘˜ | `[this]`                      | è®¿é—®æˆå‘˜å˜é‡       |
| é¿å… this æ‚¬ç©º | `[self = shared_from_this()]` | æ™ºèƒ½æŒ‡é’ˆæ•è·ç¡®ä¿å¯¹è±¡å­˜æ´» |

---

å¯è¿›ä¸€æ­¥æ‹“å±•ï¼š**æ‰€æœ‰ lambda ç¼–è¯‘ç”Ÿæˆæœºåˆ¶åŸç†ï¼ˆå¦‚ç¼–è¯‘åç”Ÿæˆé—­åŒ…å¯¹è±¡ + operator() + æ‹·è´æ„é€ ï¼‰**ï¼Œæˆ– **ç»“åˆå®é™…å¤šçº¿ç¨‹/ç®—æ³•å·¥ç¨‹åœºæ™¯è®²è§£å…·ä½“å†™æ³•ä¸ä¼˜åŒ–æ€è·¯**

====

 **å¤šçº¿ç¨‹ä¸­ lambda çš„å‡½æ•°ç»‘å®šå’Œå¼•ç”¨é—®é¢˜**ï¼Œç¡®å®æ˜¯ C++ lambda ä½¿ç”¨ä¸­æœ€å®¹æ˜“å‡º bugã€æœ€éœ€è¦æ³¨æ„çš„é«˜é˜¶åœºæ™¯ä¹‹ä¸€ã€‚ä»å®é™… **lambda ä¸çº¿ç¨‹/å¼‚æ­¥/ç”Ÿå‘½å‘¨æœŸ** åœºæ™¯è§’åº¦ï¼Œæ·±å…¥æ¢è®¨ï¼š

---

## âœ… ä¸€ã€å¤šçº¿ç¨‹åœºæ™¯ä¸‹ lambda å¸¸è§ç”¨æ³•

### âœ… 1. ç›´æ¥ä¼  lambda ç»™ `std::thread`

```cpp
int x = 10;
std::thread t([x]() {
    std::cout << "x = " << x << "\n";
});
t.join();
```

* **æŒ‰å€¼æ•è·**ï¼šå¯å®‰å…¨æ‹·è´åˆ°æ–°çº¿ç¨‹ã€‚
* âš ï¸ è‹¥ `[&x]` åˆ™å¿…é¡»ç¡®ä¿ x åœ¨ lambda æ‰§è¡ŒæœŸé—´ä»ç„¶å­˜åœ¨ã€‚

---

### âœ… 2. lambda å¼•ç”¨æ•è·å¯¼è‡´ **æ‚¬ç©ºå¼•ç”¨**

```cpp
std::thread t;
{
    int x = 10;
    t = std::thread([&]() {
        std::cout << x;  // âŒ å¼•ç”¨æ‚¬ç©º
    });
} // x å·²é”€æ¯
t.join();
```

âœ… **è§£å†³æ–¹æ¡ˆ**ï¼š

* ç”¨å€¼æ•è· `[x]`
* ä½¿ç”¨ `std::shared_ptr<int> p = std::make_shared<int>(x);` å¹¶æ•è· `p`

---

### âœ… 3. æ•è· `this` æŒ‡é’ˆçš„ç”Ÿå‘½å‘¨æœŸé£é™©

```cpp
class Task {
public:
    void start() {
        std::thread([this]() {
            std::this_thread::sleep_for(std::chrono::seconds(1));
            std::cout << data << "\n";  // âŒ è‹¥å¯¹è±¡å·²ææ„åˆ™æ˜¯ UB
        }).detach();
    }
private:
    int data = 42;
};
```

âš ï¸ è¿™é‡Œæ•è·çš„æ˜¯è£¸ `this` æŒ‡é’ˆï¼Œ**ä¸»å¯¹è±¡ææ„åçº¿ç¨‹ä»è®¿é—®æˆå‘˜å˜é‡ï¼Œé€ æˆ UBã€‚**

âœ… æ­£ç¡®æ–¹å¼ï¼ˆç”¨ `shared_ptr` å»¶é•¿ç”Ÿå‘½å‘¨æœŸï¼‰ï¼š

```cpp
class Task : public std::enable_shared_from_this<Task> {
public:
    void start() {
        auto self = shared_from_this();  // æ•è·æ™ºèƒ½æŒ‡é’ˆ
        std::thread([self]() {
            std::this_thread::sleep_for(std::chrono::seconds(1));
            std::cout << self->data << "\n";
        }).detach();
    }
private:
    int data = 42;
};
```

---

## âœ… äºŒã€ç»“åˆ `std::function`/`std::bind`/`async` ç­‰åœºæ™¯çš„æ‰©å±•ä½¿ç”¨

### âœ… 1. ä¸ `std::async` ç»“åˆ

```cpp
int x = 10;
auto fut = std::async(std::launch::async, [x]() {
    return x * 2;
});
std::cout << fut.get();  // è¾“å‡º 20
```

* åŒæ ·æ³¨æ„å€¼ vs å¼•ç”¨æ•è·ã€‚

---

### âœ… 2. ç»“åˆ `std::function` ç”¨äºä»»åŠ¡é˜Ÿåˆ—ï¼ˆå¦‚çº¿ç¨‹æ± ï¼‰

```cpp
std::queue<std::function<void()>> tasks;
int a = 1;
tasks.push([a]() { std::cout << a; });  // æ‹·è´å®‰å…¨
```

* âš ï¸ æ³¨æ„ lambda å†…ä¸èƒ½ä¾èµ–ä¸´æ—¶å¯¹è±¡ç”Ÿå‘½å‘¨æœŸã€‚
* ä½¿ç”¨ `std::function<void()>` ä¼šç±»å‹æ“¦é™¤ï¼Œå¯èƒ½å½±å“æ€§èƒ½ã€‚

---

### âœ… 3. `std::bind` vs lambda çš„æ›¿ä»£å…³ç³»ï¼ˆä¸æ¨è bindï¼‰

```cpp
// è€å¼å†™æ³•
auto bound = std::bind(&SomeClass::func, this, 123);

// æ¨èç°ä»£å†™æ³•
auto f = [this]() { func(123); };
```

lambda å¯è¯»æ€§æ›´å¥½ã€æ›´çµæ´»ã€å¯ç»„åˆã€‚

---

## âœ… ä¸‰ã€æ•è·å¤æ‚å¯¹è±¡ & æ™ºèƒ½æŒ‡é’ˆåœºæ™¯

### âœ… 1. æ•è· shared\_ptr

```cpp
std::shared_ptr<MyClass> p = std::make_shared<MyClass>();
auto f = [p]() {
    p->do_work();
};
```

ä¼˜ç‚¹ï¼š

* å»¶é•¿å¯¹è±¡ç”Ÿå‘½å‘¨æœŸ
* é¿å…è£¸æŒ‡é’ˆæ‚¬ç©º

---

### âœ… 2. æ•è· unique\_ptrï¼ˆéœ€è½¬ç§»ï¼‰

```cpp
std::unique_ptr<MyClass> p = std::make_unique<MyClass>();
auto f = [p = std::move(p)]() {
    p->do_work();
};
```

âš ï¸ `unique_ptr` æ— æ³•å¤åˆ¶ï¼Œåªèƒ½è½¬ç§»ï¼ˆéœ€åœ¨æ•è·åˆ—è¡¨ä¸­ä½¿ç”¨ `p = std::move(p)`ï¼‰

---

## âœ… å››ã€lambda ä¸åç¨‹ã€ä»»åŠ¡è°ƒåº¦é…åˆ

åœ¨ç°ä»£ C++ï¼ˆ20/23ï¼‰ä¸­å¸¸è§ä»¥ä¸‹ç»„åˆï¼š

### âœ… 1. lambda ç”¨äºçŠ¶æ€å°è£…çš„å¼‚æ­¥ä»»åŠ¡é€»è¾‘

```cpp
auto task = [=](std::function<void(int)> cb) {
    std::thread([=]() {
        int result = do_work();
        cb(result);
    }).detach();
};
```

* ä»»åŠ¡é€»è¾‘å†™æˆ lambda
* å¼‚æ­¥æ‰§è¡Œ
* å›è°ƒä¹Ÿæ˜¯ lambda

---

### âœ… 2. lambda å°è£…åç¨‹è°ƒåº¦å™¨ï¼ˆä¸ coroutines é…åˆï¼‰

```cpp
co_spawn(io_context, []() -> awaitable<void> {
    co_await some_async_op();
    co_return;
}, detached);
```

---

## âœ… äº”ã€lambda çš„é—­åŒ…å¯¹è±¡åº•å±‚åŸç†

ç¼–è¯‘å™¨ä¼šå°† lambda ç¼–è¯‘ä¸ºå¦‚ä¸‹ç»“æ„ï¼š

```cpp
struct __lambda_123 {
    int x;  // æŒ‰å€¼æ•è·çš„å˜é‡
    int operator()(int y) const {
        return x + y;
    }
};
```

ä¹Ÿå°±æ˜¯è¯´ï¼Œ**æ¯ä¸ª lambda éƒ½æ˜¯ç¼–è¯‘å™¨ç”Ÿæˆçš„â€œæ— åç±» + operator()â€å¯¹è±¡ã€‚**

---

## âš ï¸ å…­ã€å®¹æ˜“è¸©å‘çš„è¯¯æ“ä½œæ€»ç»“è¡¨

| é”™è¯¯ç”¨æ³• / åœºæ™¯                    | é—®é¢˜æè¿°                         | è§£å†³æ–¹å¼                          |
| ---------------------------- | ---------------------------- | ----------------------------- |
| `[&x]` æ•è·å±€éƒ¨å˜é‡ç”¨äºçº¿ç¨‹            | x å·²ææ„ï¼Œlambda ä½¿ç”¨æ—¶æ‚¬ç©º           | `[x]` æˆ–æ•è· `shared_ptr`        |
| `[this]` æ•è·åå¯¹è±¡å·²ææ„            | lambda ä¸­è®¿é—®æˆå‘˜å˜é‡æ—¶å´©æºƒ            | `[self = shared_from_this()]` |
| å¿˜è®° `mutable` å¯¼è‡´ä¸èƒ½ä¿®æ”¹å‰¯æœ¬        | `[x]() { x++; }` æŠ¥é”™          | åŠ ä¸Š `mutable`                  |
| ä½¿ç”¨ `std::thread([&](){...})` | ä¸æ¸…æ¥šå¼•ç”¨ç”Ÿå‘½å‘¨æœŸ                    | å°½é‡ä½¿ç”¨å€¼æ•è·                       |
| æ•è· `unique_ptr` æŠ¥é”™           | lambda é»˜è®¤å¤åˆ¶ï¼Œunique\_ptr ä¸å¯å¤åˆ¶ | æ˜¾å¼ `[p = std::move(p)]`       |
| æ•è·å¤ªå¤šå˜é‡é€ æˆé—­åŒ…è†¨èƒ€                 | æ€§èƒ½é—®é¢˜æˆ–è°ƒè¯•å›°éš¾                    | æ˜ç¡®æ•è·å˜é‡ï¼Œé¿å… `[=]` æˆ– `[&]`       |
| æ³›å‹ lambda å¼•å‘æ¨¡æ¿è†¨èƒ€             | ç¼–è¯‘æ—¶é—´å˜æ…¢ï¼Œä»£ç  bloat              | é™åˆ¶ä½¿ç”¨åœºæ™¯                        |
| `std::function` ç±»å‹æ“¦é™¤æ€§èƒ½ä¸‹é™     | é—­åŒ…å¯¹è±¡è½¬ std::function ä¼šå †åˆ†é…     | ç”¨æ¨¡æ¿å‚æ•°/inline æ›¿ä»£               |

---

## âœ… ä¸ƒã€æœ€ä½³å®è·µæ€»ç»“

| åœºæ™¯                    | å»ºè®®å†™æ³•                                            |
| --------------------- | ----------------------------------------------- |
| ç®€å•å‡½æ•°é€»è¾‘                | `[x](int y) { return x + y; }`                  |
| å¤šçº¿ç¨‹ã€å»¶è¿Ÿæ‰§è¡Œ              | `[x]() { do_something(x); }`                    |
| å‡½æ•°å›è°ƒï¼Œç¡®ä¿ this ç”Ÿå‘½å‘¨æœŸ     | `[self = shared_from_this()] { self->work(); }` |
| æ•è·æ™ºèƒ½æŒ‡é’ˆ                | `[p]() { p->do_work(); }`                       |
| æ•è·ç§»åŠ¨å¯¹è±¡ï¼ˆå¦‚ unique\_ptrï¼‰ | `[p = std::move(p)]() { p->do_work(); }`        |
| é¿å…è†¨èƒ€                  | é¿å… `[=]`, å¤šå˜é‡å»ºè®®æ˜¾ç¤ºæ•è·                             |

---

å¦‚æœä½ æƒ³æ›´è¿›ä¸€æ­¥ï¼Œå¯ä»¥ç»“åˆä½ è‡ªå·±çš„é¡¹ç›®ï¼ˆå¦‚çº¿ç¨‹æ± ã€è°ƒåº¦å™¨ã€å¼‚æ­¥ä»»åŠ¡ç³»ç»Ÿï¼‰ï¼Œæˆ‘å¯ä»¥å¸®ä½ é‡èº«æ„å»ºä¸€å¥— **lambda é£æ ¼æ ‡å‡† + å®‰å…¨å°è£…æœºåˆ¶ï¼ˆå¦‚ä»»åŠ¡åŒ… TaskWrapperï¼‰**ï¼Œå¹¶ç”Ÿæˆç¤ºä¾‹ä»£ç ã€‚

å¯ä»¥ç»§ç»­æŒ–æ˜ `lambda` ä¸ `æ¨¡æ¿å…ƒç¼–ç¨‹`ã€`Reactor æ¨¡å‹ä¸­çš„ IO å›è°ƒå°è£…` ç­‰åœºæ™¯

åœ¨ C++ ä¸­æåˆ° **â€œå†…åµŒçš„åŒ¿åå‡½æ•°â€**ï¼ˆinlined anonymous functionï¼‰ï¼Œä¸€èˆ¬æ˜¯éæ­£å¼çš„æœ¯è¯­ï¼Œå®é™…æ˜¯æŒ‡ï¼š

---

## âœ… ä¸€ã€ä»€ä¹ˆæ˜¯â€œå†…åµŒçš„åŒ¿åå‡½æ•°â€ï¼Ÿ

### âœ… å®šä¹‰ï¼ˆéæ ‡å‡†æœ¯è¯­ï¼‰ï¼š

**å†…åµŒçš„åŒ¿åå‡½æ•°** â‰ˆ **lambda è¡¨è¾¾å¼è¢«å°±åœ°å®šä¹‰å¹¶ç›´æ¥ä½¿ç”¨**ï¼Œæ²¡æœ‰å‘½åï¼Œä¹Ÿæ²¡æœ‰å­˜å‚¨ä¸ºå˜é‡ï¼Œ**ç´§åµŒåœ¨æŸä¸ªè°ƒç”¨è¯­å¥ä¸­**ã€‚

### âœ… ä¸¾ä¾‹ï¼š

```cpp
std::vector<int> v = {1, 2, 3};
std::for_each(v.begin(), v.end(), [](int x) {
    std::cout << x << " ";
});
```

è¿™é‡Œçš„ `[](int x){...}` å°±æ˜¯ä¸€ä¸ªï¼š

* **åŒ¿åçš„ï¼ˆæ²¡æœ‰åå­—ï¼‰**
* **å†…åµŒçš„ï¼ˆç›´æ¥å†™åœ¨å‡½æ•°å‚æ•°ä½ç½®ï¼‰**
* **å‡½æ•°å¯¹è±¡ï¼ˆé—­åŒ…ï¼‰**

å®ƒé€šå¸¸æ˜¯ï¼š**ä¸´æ—¶ç”Ÿæˆçš„ lambda è¡¨è¾¾å¼**ï¼Œåªç”¨äºä¸€æ¬¡æ€§è°ƒç”¨æˆ–ä¼ é€’ã€‚

---

## âœ… äºŒã€å†…åµŒ lambdaï¼ˆåŒ¿åå‡½æ•°ï¼‰æœ‰å“ªäº›è¡¨ç°å½¢å¼ï¼Ÿ

### âœ… è¡¨ç°å½¢å¼ 1ï¼šä½œä¸ºå‡½æ•°å‚æ•°ç›´æ¥ä¼ å…¥

```cpp
std::sort(arr.begin(), arr.end(), [](int a, int b) {
    return a < b;
});
```

* ä¸å£°æ˜å˜é‡ï¼Œä¸å¤ç”¨
* å†…è”ä½ç½®å®šä¹‰ï¼Œé€»è¾‘æ¸…æ™°
* å¸¸ç”¨äº STL ç®—æ³•ã€å¤šçº¿ç¨‹ä»»åŠ¡ã€å›è°ƒç­‰

---

### âœ… è¡¨ç°å½¢å¼ 2ï¼šç«‹å³è°ƒç”¨ï¼ˆIIFEï¼Œç«‹å³è°ƒç”¨å‡½æ•°è¡¨è¾¾å¼ï¼‰

```cpp
int x = []() {
    return 42;
}();  // å®šä¹‰åç«‹å³è°ƒç”¨
```

* ç­‰ä»·äº JavaScript ä¸­çš„ IIFEï¼ˆImmediately Invoked Function Expressionï¼‰
* å¸¸ç”¨äºæ„é€ å¸¸é‡ã€ä¸´æ—¶å€¼ã€lambda å°è£…å¤æ‚åˆå§‹åŒ–é€»è¾‘ç­‰

---

### âœ… è¡¨ç°å½¢å¼ 3ï¼šè¿”å›å‡½æ•°å¯¹è±¡

```cpp
auto makeAdder = [](int x) {
    return [x](int y) { return x + y; };
};
auto add10 = makeAdder(10);
std::cout << add10(5);  // è¾“å‡º 15
```

* è¿™æ˜¯ **åµŒå¥— lambda**ï¼šlambda è¿”å›å¦ä¸€ä¸ª lambda
* å†…åµŒçš„æ˜¯ return å‡ºæ¥çš„åŒ¿åå‡½æ•°ï¼ˆé—­åŒ…ï¼‰

---

## âœ… ä¸‰ã€å†…åµŒåŒ¿åå‡½æ•°çš„ä¼˜åŠ¿

| ä¼˜åŠ¿        | è¯´æ˜             |
| --------- | -------------- |
| é¿å…å‘½åæ±¡æŸ“    | æ— éœ€ä¸ºä¸€æ¬¡æ€§é€»è¾‘å‘½åå‡½æ•°å  |
| æ›´é è¿‘ä½¿ç”¨å¤„ï¼Œæ˜“è¯» | å‡½æ•°ä½“å†™åœ¨è°ƒç”¨å¤„ï¼Œæ›´æ¸…æ™°ç›´è§‚ |
| æ”¯æŒå‡½æ•°å¼ç¼–ç¨‹é£æ ¼ | å°è£…è¡Œä¸ºä½œä¸ºå‚æ•°ä¼ é€’     |
| å¯ä»¥æ•è·å¤–éƒ¨å˜é‡  | æ¯”å‡½æ•°æŒ‡é’ˆçµæ´»ï¼Œæ”¯æŒçŠ¶æ€æºå¸¦ |

---

## âš ï¸ å››ã€å¯èƒ½çš„é—®é¢˜å’Œè¯¯è§£ç‚¹

### âŒ ä¸æ˜¯çœŸæ­£â€œå†…è”å‡½æ•°â€

* `inline` å’Œ lambda æ²¡æœ‰ç›´æ¥å…³ç³»
* æ˜¯å¦è¢«ç¼–è¯‘å™¨å†…è”ä¼˜åŒ–æ˜¯å¦ä¸€ä¸ªç»´åº¦çš„äº‹

### âŒ å¤šå±‚å†…åµŒå¯è¯»æ€§å·®

```cpp
auto result = [](int x) {
    return [](int y) {
        return y + 1;
    }(x * 2);
}(5);
```

â¡ï¸ å¤æ‚åµŒå¥—è®©ä»£ç éš¾ä»¥ç»´æŠ¤ï¼Œå»ºè®®æå–å‡ºå‘½å lambda æˆ–å‡½æ•°å¯¹è±¡

---

## âœ… äº”ã€ç»“åˆç¼–è¯‘å™¨è§†è§’ï¼šå®ƒæ˜¯ä¸€ä¸ªä¸´æ—¶é—­åŒ…å¯¹è±¡

```cpp
[](int x) { return x + 1; }(5);
```

ç­‰ä»·äºç”Ÿæˆä¸€ä¸ªå¦‚ä¸‹çš„ä¸´æ—¶ç±»ï¼š

```cpp
struct __lambda {
    int operator()(int x) const {
        return x + 1;
    }
};
int result = __lambda{}(5);
```

â¡ï¸ è¿™å°±æ˜¯â€œåŒ¿å + å†…åµŒ + ä¸´æ—¶â€çš„ä¸‰é‡ç‰¹æ€§ã€‚

---

## âœ… å…­ã€å·¥ç¨‹ä¸­å¸¸è§çš„å†…åµŒåŒ¿åå‡½æ•°åœºæ™¯

| åœºæ™¯     | ä¾‹å­                                                              | ç‰¹ç‚¹         |
| ------ | --------------------------------------------------------------- | ---------- |
| STL ç®—æ³• | `std::for_each(vec.begin(), vec.end(), [](int x){...});`        | å†…åµŒï¼Œæ¸…æ™°      |
| å›è°ƒ     | `btn.onClick([](){...});`                                       | ç®€çŸ­å›è°ƒ       |
| æ¡ä»¶åˆå§‹åŒ–  | `auto value = [](){ return compute(); }();`                     | è¡¨è¾¾å¼åˆå§‹åŒ–     |
| å¤šçº¿ç¨‹ä»»åŠ¡  | `std::thread([](){...}).detach();`                              | lambda ä»»åŠ¡ä½“ |
| å¼‚å¸¸åŒ…è£…   | `try { ... } catch (...) { std::rethrow_if_nested([](){}()); }` | éå¸¸è§„ä½¿ç”¨      |

---

## âœ… æ€»ç»“ä¸€å¥è¯ï¼š

> **â€œå†…åµŒåŒ¿åå‡½æ•°â€æŒ‡çš„æ˜¯ç›´æ¥å†™åœ¨è¡¨è¾¾å¼ã€å‡½æ•°å‚æ•°ã€åˆå§‹åŒ–ç­‰ä½ç½®çš„ lambda è¡¨è¾¾å¼ï¼Œå®ƒæ˜¯åŒ¿åçš„ã€å°±åœ°å®šä¹‰çš„é—­åŒ…å¯¹è±¡ï¼Œç”¨äºä¸€æ¬¡æ€§é€»è¾‘ï¼Œæå¤§åœ°æå‡äº†ä»£ç çš„è¡¨è¾¾åŠ›å’Œå±€éƒ¨æ€§ã€‚â€**

---

å¯ä»¥è¿›ä¸€æ­¥æ‹“å±•ï¼š â€œå†…åµŒ lambda ä¸æ€§èƒ½åˆ†æï¼ˆæ¯”å¦‚æ˜¯å¦ä¼šå†…è”ä¼˜åŒ–ã€æ˜¯å¦ä¼šæ•è·ç”Ÿå‘½å‘¨æœŸå¼€é”€ï¼‰â€æˆ–â€œç”¨äºå¼‚æ­¥å¼•æ“åœºæ™¯ï¼ˆå¦‚ç»‘å®šå›è°ƒ/çŠ¶æ€å°è£…ï¼‰â€


=============

**ç³»ç»Ÿè§£é‡Šâ€œä¸ºä»€ä¹ˆè¿™ç§ lambda ç”¨æ³•å±äºåŒ¿åå‡½æ•°â€**ï¼š

---

## âœ… 1. ä»€ä¹ˆæ˜¯â€œåŒ¿åå‡½æ•°â€ï¼Ÿ

åœ¨ C++ ä¸­ï¼Œ**åŒ¿åå‡½æ•°**æŒ‡çš„æ˜¯ï¼š

> ä¸€ä¸ªæ²¡æœ‰åå­—çš„å‡½æ•°å¯¹è±¡ â€”â€” ä¹Ÿå°±æ˜¯ `lambda è¡¨è¾¾å¼`ã€‚

**â€œæ²¡æœ‰åå­—â€** æ˜¯å…³é”®ã€‚å³ï¼š

* ä¸æ˜¯ä½ é€šè¿‡ `void func() {}` æ˜¾å¼å£°æ˜çš„å‡½æ•°ï¼›
* ä¹Ÿä¸æ˜¯å‘½åçš„ `std::function` æˆ–å‡½æ•°æŒ‡é’ˆï¼›
* è€Œæ˜¯åƒ `[](int x){ return x + 1; }` è¿™ç§ **ä¸´æ—¶æ„é€ å‡ºæ¥çš„å‡½æ•°å¯¹è±¡**ã€‚

---

## âœ… 2. ä¾‹å­åˆ†æ

æ¥çœ‹ä½ æåˆ°çš„å½¢å¼ï¼š

```cpp
std::for_each(vec.begin(), vec.end(), [](int x) {
    std::cout << x << " ";
});
```

è¿™å…¶ä¸­ï¼š

* `[](int x) { ... }` æ˜¯ **lambda è¡¨è¾¾å¼**
* å®ƒæ²¡æœ‰åå­—ï¼ˆåŒ¿åï¼‰
* ä¹Ÿæ²¡æœ‰è¢«èµ‹å€¼ç»™æŸä¸ªå˜é‡
* **å®ƒæ˜¯ç›´æ¥è¢«ä¼ å…¥å‡½æ•°è°ƒç”¨çš„è¡¨è¾¾å¼**

å› æ­¤ï¼Œè¿™æ˜¯ä¸€ä¸ª**æ ‡å‡†çš„åŒ¿åå‡½æ•°ä½¿ç”¨åœºæ™¯**ã€‚

---

## âœ… 3. ä¸ºä»€ä¹ˆæ˜¯åŒ¿åè€Œä¸æ˜¯å‘½åå‡½æ•°ï¼Ÿ

æˆ‘ä»¬æ¯”è¾ƒä¸€ä¸‹ï¼š

### âœ… å‘½åå‡½æ•°

```cpp
int add(int a, int b) {
    return a + b;
}
```

* å‡½æ•°åæ˜¯ `add`
* ç¼–è¯‘å™¨çŸ¥é“ `add` çš„å…¨å±€ç¬¦å·

### âœ… åŒ¿å lambdaï¼ˆæ— å˜é‡åï¼‰

```cpp
[](int a, int b) { return a + b; }
```

* æ²¡æœ‰å‡½æ•°åï¼Œä¹Ÿæ²¡æœ‰å˜é‡å
* è¿™æ˜¯ä¸€ä¸ªåŒ¿åé—­åŒ…å¯¹è±¡
* ç¼–è¯‘å™¨ä¼šç”Ÿæˆä¸€ä¸ªç±»ä¼¼ `struct __lambda1 { operator()() {...} };` çš„ç±»

### âœ… åŒ¿åä½†å­˜å…¥å˜é‡ï¼ˆå˜é‡å‘½å â‰  å‡½æ•°å‘½åï¼‰

```cpp
auto add = [](int a, int b) { return a + b; };
```

* è™½ç„¶å˜é‡å« `add`
* ä½†å‡½æ•°å¯¹è±¡æœ¬èº«ä»æ˜¯**åŒ¿åç±»å®ä¾‹**
* ä½ æ²¡å‘½åå‡½æ•°çš„ç±»å‹å’Œç±»

---

## âœ… 4. lambda çš„åº•å±‚æœ¬è´¨å†³å®šäº†å®ƒåŒ¿å

æ¯ä¸ª lambda è¡¨è¾¾å¼ï¼Œæœ¬è´¨ä¸Šï¼š

> æ˜¯ç¼–è¯‘å™¨ç”Ÿæˆçš„æ— åç±»ï¼ˆclosure classï¼‰ç±»å‹çš„ä¸€ä¸ªå¯¹è±¡ï¼Œå…·æœ‰ `operator()` é‡è½½ã€‚

ä¾‹å¦‚ï¼š

```cpp
[](int x){ return x + 1; }
```

ç›¸å½“äºç”Ÿæˆå¦‚ä¸‹ç»“æ„ï¼š

```cpp
struct __lambda_123 {
    int operator()(int x) const {
        return x + 1;
    }
};
__lambda_123{};  // ä¸´æ—¶å¯¹è±¡ï¼Œæ— åå­—
```

â¡ï¸ æ‰€ä»¥ï¼š**å®ƒæ ¹æœ¬ä¸æ˜¯ä½ å®šä¹‰çš„ä¸€ä¸ªå…·åå‡½æ•°ï¼Œè€Œæ˜¯åŒ¿åæ„é€ å‡ºæ¥çš„å‡½æ•°å¯¹è±¡ã€‚**

---

## âœ… 5. æ€»ç»“ä¸€å¥è¯ï¼š

> åªè¦æ˜¯ `lambda è¡¨è¾¾å¼`ï¼Œå®ƒå°±æ˜¯åŒ¿åå‡½æ•°ï¼Œæ— è®ºæ˜¯å¦è¢«èµ‹å€¼ç»™å˜é‡ã€‚å› ä¸ºä½ æ²¡æœ‰æ˜¾å¼å‘½åè¿™ä¸ªå‡½æ•°çš„â€œç±»å‹â€æˆ–â€œåå­—â€ï¼Œ**å®ƒçš„å‡½æ•°ä½“æ²¡æœ‰åå­—**ï¼Œ**ç±»å‹æ˜¯ç”±ç¼–è¯‘å™¨ç”Ÿæˆçš„åŒ¿åé—­åŒ…ç±»å‹**ã€‚

---

å¯è¿›ä¸€æ­¥æ‹“å±•ï¼š

* ç¼–è¯‘å™¨å¦‚ä½•æŠŠ lambda è½¬æ¢ä¸ºåŒ¿åç±»ç»“æ„
* ä½¿ç”¨ `typeid(lambda).name()` æ‰“å°å®ƒçš„åŒ¿åç±»å‹å
* åŒ¿å vs å‘½åå‡½æ•°åœ¨é“¾æ¥/è°ƒè¯•ä¿¡æ¯ä¸­çš„å·®å¼‚


### âœ… ä»€ä¹ˆæ˜¯ä»¿å‡½æ•°ï¼ˆFunction Object / Functorï¼‰ï¼Ÿ

**ä»¿å‡½æ•°**ï¼Œåˆå« **å‡½æ•°å¯¹è±¡ï¼ˆFunction Objectï¼‰**ï¼Œæ˜¯ C++ ä¸­ä¸€ç§ **è¡Œä¸ºç±»ä¼¼å‡½æ•°çš„å¯¹è±¡**ã€‚å®ƒæ˜¯ä¸€ä¸ª **é‡è½½äº† `operator()` è¿ç®—ç¬¦çš„ç±»æˆ–ç»“æ„ä½“çš„å®ä¾‹**ï¼Œä½ å¯ä»¥åƒè°ƒç”¨å‡½æ•°ä¸€æ ·è°ƒç”¨å®ƒã€‚

---

## âœ… ä¸€å¥è¯å®šä¹‰ï¼š

> **ä»¿å‡½æ•°æ˜¯ä¸€ä¸ªå¯ä»¥åƒå‡½æ•°ä¸€æ ·è¢«è°ƒç”¨çš„å¯¹è±¡ï¼ˆæœ‰ `()` è¿ç®—ç¬¦ï¼‰ã€‚**

---

## âœ… ç¤ºä¾‹ï¼šæœ€ç®€å•çš„ä»¿å‡½æ•°

```cpp
struct Adder {
    int operator()(int a, int b) const {
        return a + b;
    }
};

int main() {
    Adder add;              // åˆ›å»ºä»¿å‡½æ•°å¯¹è±¡
    std::cout << add(3, 5); // è¾“å‡º 8ï¼Œåƒå‡½æ•°ä¸€æ ·è°ƒç”¨
}
```

---

## âœ… ä»¿å‡½æ•° vs æ™®é€šå‡½æ•°

| æ¯”è¾ƒé¡¹      | ä»¿å‡½æ•°                 | æ™®é€šå‡½æ•°          |
| -------- | ------------------- | ------------- |
| è¯­æ³•       | å¯¹è±¡è°ƒç”¨ï¼š`obj()`        | å‡½æ•°è°ƒç”¨ï¼š`func()` |
| å¯æºå¸¦çŠ¶æ€    | âœ… å¯ä»¥å­˜å‚¨çŠ¶æ€            | âŒ æ— æ³•ä¿å­˜çŠ¶æ€      |
| å¤šæ€æ€§      | âœ… æ”¯æŒ operator() çš„é‡è½½ | âŒ å‡½æ•°ä¸èƒ½å¤šæ€      |
| ä¸ STL é…åˆ | âœ… æœ€ä½³åŒ¹é…ï¼ˆæ’åºã€æŸ¥æ‰¾ç­‰ï¼‰      | â­• æœ‰æ—¶å¯è¡Œ        |
| ç±»å‹       | ç±»å¯¹è±¡ï¼ˆç±»å‹æ˜ç¡®ï¼‰           | å‡½æ•°æŒ‡é’ˆ / ç¬¦å·     |

---

## âœ… ä»¿å‡½æ•°çš„å¸¸è§ç”¨é€”

### âœ… 1. STL ä¸­ä½œä¸ºæ¯”è¾ƒå™¨

```cpp
struct Greater {
    bool operator()(int a, int b) const {
        return a > b;
    }
};

std::priority_queue<int, std::vector<int>, Greater> pq;
```

---

### âœ… 2. è‡ªå®šä¹‰æ’åºè§„åˆ™

```cpp
struct ByLength {
    bool operator()(const std::string& a, const std::string& b) const {
        return a.size() < b.size();
    }
};

std::sort(v.begin(), v.end(), ByLength{});
```

---

### âœ… 3. å¯æºå¸¦çŠ¶æ€çš„å‡½æ•°å¯¹è±¡ï¼ˆåŒºåˆ«äºå‡½æ•°æŒ‡é’ˆï¼‰

```cpp
struct MultiplyBy {
    int factor;
    MultiplyBy(int f) : factor(f) {}

    int operator()(int x) const {
        return x * factor;
    }
};

auto times10 = MultiplyBy(10);
std::cout << times10(5);  // è¾“å‡º 50
```

---

### âœ… 4. ä¸æ¨¡æ¿ã€æ³›å‹ç®—æ³•ç»“åˆ

```cpp
template<typename Func>
void apply(Func f, int x) {
    std::cout << f(x) << "\n";
}

struct Square {
    int operator()(int x) const { return x * x; }
};

apply(Square{}, 4);  // è¾“å‡º 16
```

---

## âœ… ä»¿å‡½æ•°ä¸ lambda çš„å…³ç³»

> **lambda è¡¨è¾¾å¼å°±æ˜¯ä¸€ç§è‡ªåŠ¨ç”Ÿæˆçš„ä»¿å‡½æ•°**ï¼

```cpp
auto lambda = [](int x) { return x * x; };
// ç­‰ä»·äºä¸€ä¸ªæ— å struct çš„ä»¿å‡½æ•°å¯¹è±¡
```

èƒŒåç¼–è¯‘å™¨ç”Ÿæˆç±»ä¼¼ï¼š

```cpp
struct __lambda {
    int operator()(int x) const { return x * x; }
};
```

---

## âœ… è¿›é˜¶ç‰¹æ€§ï¼šå¯å˜å‚æ•°ä»¿å‡½æ•°ã€å¤šæ€ä»¿å‡½æ•°

```cpp
struct Logger {
    template<typename... Args>
    void operator()(Args&&... args) {
        (std::cout << ... << args) << '\n';
    }
};

Logger{}("Error at ", __FILE__, ":", __LINE__);
```

---

## âœ… æ€»ç»“

| ç‰¹æ€§       | ä»¿å‡½æ•°ä½“ç°        |
| -------- | ------------ |
| åƒå‡½æ•°ä¸€æ ·è°ƒç”¨  | `operator()` |
| æ”¯æŒçŠ¶æ€     | æˆå‘˜å˜é‡         |
| æ”¯æŒæ³›å‹     | æ¨¡æ¿ä»¿å‡½æ•°        |
| STL å…¼å®¹æ€§  | éå¸¸å¼º          |
| lambda æ˜¯ | è‡ªåŠ¨ç”Ÿæˆçš„ä»¿å‡½æ•°å¯¹è±¡   |

---

## âœ… é¢è¯•å¸¸é—®ï¼š

* **ä»€ä¹ˆæ˜¯ä»¿å‡½æ•°ï¼Ÿ**
* **ä»¿å‡½æ•° vs å‡½æ•°æŒ‡é’ˆæœ‰ä½•ä¸åŒï¼Ÿ**
* **å¦‚ä½•ç”¨ä»¿å‡½æ•°å®šåˆ¶æ’åºï¼Ÿ**
* **lambda å’Œä»¿å‡½æ•°çš„å…³ç³»ï¼Ÿ**
* **èƒ½å†™ä¸€ä¸ªå¸¦çŠ¶æ€çš„ä»¿å‡½æ•°åº”ç”¨å—ï¼Ÿ**

---

è¿›ä¸€æ­¥æ‹“å±•æ–¹å‘ï¼š

* ä»¿å‡½æ•°å¯¹è±¡çš„ç±»å‹æ“¦é™¤ï¼ˆä¸ `std::function` ç»“åˆï¼‰
* STL å†…ç½®ä»¿å‡½æ•°ï¼ˆå¦‚ `std::plus<>`, `std::less<>`ï¼‰
* æˆ–åœ¨å¤šçº¿ç¨‹ / å›è°ƒ / å¹¶å‘æ§åˆ¶åœºæ™¯ä¸‹çš„åº”ç”¨




---

## âœ… ç®€æ˜å›ç­”ï¼š

**åœ¨ C++ ä¸­ï¼Œlambda è¡¨è¾¾å¼æŒ‰å€¼æ•æ‰çš„å˜é‡é»˜è®¤æ˜¯ `const` çš„ï¼ˆä¸å¯ä¿®æ”¹ï¼‰ï¼Œ**
**é™¤éä½ æ˜¾å¼ä½¿ç”¨ `mutable` å…³é”®å­—ã€‚**

---

## âœ… ç¤ºä¾‹è¯´æ˜

```cpp
int x = 10;
auto f = [x]() {
    // x++;  âŒ ç¼–è¯‘é”™è¯¯ï¼šx æ˜¯ const çš„
    std::cout << x << std::endl;
};
```

è¿™æ˜¯å› ä¸ºé»˜è®¤æƒ…å†µä¸‹ï¼Œ**æŒ‰å€¼æ•è·çš„å˜é‡åœ¨ lambda ä¸­ç›¸å½“äº `const` å˜é‡**ï¼Œä¸èƒ½è¢«ä¿®æ”¹ã€‚

---

## âœ… å¦‚ä½•å…è®¸ä¿®æ”¹æ•è·çš„å‰¯æœ¬ï¼Ÿä½¿ç”¨ `mutable`

```cpp
int x = 10;
auto f = [x]() mutable {
    x++;  // âœ… æ­£å¸¸ï¼šæ•è·çš„æ˜¯å‰¯æœ¬ï¼Œmutable å…è®¸ä¿®æ”¹å‰¯æœ¬
    std::cout << x << std::endl;
};
f();
std::cout << x << std::endl;  // è¾“å‡ºä»æ˜¯ 10ï¼Œå¤–éƒ¨ x æœªæ”¹å˜
```

### ğŸ” åŸå› ï¼š

* lambda å†…éƒ¨å¯¹å€¼æ•è·çš„æ˜¯å‰¯æœ¬
* æ²¡æœ‰ `mutable` æ—¶ï¼Œ`operator()` è¢«ç¼–è¯‘ä¸º `const` æˆå‘˜å‡½æ•°ï¼Œå‰¯æœ¬ä¹Ÿæ˜¯ `const`
* åŠ äº† `mutable`ï¼Œlambda çš„ `operator()` æˆå‘˜å‡½æ•°å˜æˆäº† **é const**

---

## âœ… ä¸¾ä¸ªèƒŒååŸç†

è¿™ä¸ª lambdaï¼š

```cpp
auto f = [x]() { std::cout << x; };
```

ç­‰ä»·äºï¼š

```cpp
struct Lambda {
    int x;
    void operator()() const { std::cout << x; }
};
```

åŠ ä¸Š `mutable`ï¼š

```cpp
struct Lambda {
    int x;
    void operator()() { x++; std::cout << x; }
};
```

---

## âœ… é‚£å¼•ç”¨æ•è·çš„å˜é‡å‘¢ï¼Ÿ

```cpp
int x = 10;
auto f = [&x]() {
    x++;  // âœ… æ­£å¸¸ï¼šå¼•ç”¨æ•è·ç›´æ¥æ“ä½œå¤–éƒ¨å˜é‡
};
f();
std::cout << x << std::endl;  // è¾“å‡º 11
```

### ğŸ“Œ è¯´æ˜ï¼š

* å¼•ç”¨æ•è·ä¸æ¶‰åŠ `const` é™å®šï¼Œç›´æ¥æ“ä½œåŸå§‹å˜é‡ï¼Œèƒ½è¯»å†™ï¼ˆå‰ææ˜¯å˜é‡æœ¬èº«å¯å†™ï¼‰ã€‚

---

## âœ… æ€»ç»“ä¸€å¼ è¡¨

| æ•è·æ–¹å¼          | æ˜¯å¦ const | æ˜¯å¦å¯ä¿®æ”¹å˜é‡ | æ˜¯å¦ä¿®æ”¹å¤–éƒ¨å€¼ |
| ------------- | -------- | ------- | ------- |
| `[x]`         | âœ… æ˜¯      | âŒ ä¸å¯ä¿®æ”¹  | âŒ ä¸å½±å“å¤–éƒ¨ |
| `[x] mutable` | âŒ å¦      | âœ… å¯ä¿®æ”¹å‰¯æœ¬ | âŒ ä¸å½±å“å¤–éƒ¨ |
| `[&x]`        | âŒ å¦      | âœ… å¯ä¿®æ”¹   | âœ… ä¿®æ”¹å¤–éƒ¨å€¼ |

---

## âœ… æœ€ä½³å®è·µå»ºè®®

* è‹¥åªè¯»ï¼šä½¿ç”¨ `[x]` æ˜¯æœ€å®‰å…¨çš„ï¼ˆé˜²æ­¢æ„å¤–ä¿®æ”¹ï¼‰
* è‹¥è¦ä¿®æ”¹æ•è·å‰¯æœ¬ï¼šä½¿ç”¨ `[x] mutable`
* è‹¥è¦ä¿®æ”¹åŸå§‹å€¼ï¼šä½¿ç”¨ `[&x]`ï¼Œä½†æ³¨æ„ç”Ÿå‘½å‘¨æœŸå’Œå¹¶å‘å®‰å…¨

---

è¿›ä¸€æ­¥æ‹“å±•æ–¹å‘ï¼š

* æ•è· `const int&` / `const auto&` çš„æ•ˆæœ
* æ•è· move-only ç±»å‹çš„è¯­ä¹‰ï¼ˆå¦‚ `[ptr = std::move(p)]`ï¼‰
* C++20 æ•è·ç»“æ„åŒ–ç»‘å®š & C++23 æ•è· pack å±•å¼€çš„è¡Œä¸º


=========




## ğŸ“˜ åšå®¢æ ‡é¢˜å»ºè®®

**ã€Šä»å…¥é—¨åˆ°å®æˆ˜ï¼šæ·±å…¥ç†è§£ C++ Lambda è¡¨è¾¾å¼åŠå…¶åœ¨å¤šçº¿ç¨‹ä¸­çš„é«˜æ•ˆåº”ç”¨ã€‹**

---

## ğŸ§± åšå®¢å†…å®¹ç»“æ„æçº²ï¼ˆå¸¦å†…å®¹è‰ç¨¿ï¼‰

---

### âœ… ä¸€ã€å‰è¨€ï¼šä¸ºä»€ä¹ˆè¦å…³æ³¨ lambda ä¸å¤šçº¿ç¨‹ï¼Ÿ

```markdown
C++11 å¼•å…¥çš„ lambda è¡¨è¾¾å¼ï¼Œä¸ºæˆ‘ä»¬å¸¦æ¥äº†å¼ºå¤§çš„â€œå°±åœ°å®šä¹‰å‡½æ•°â€èƒ½åŠ›ã€‚æ— è®ºæ˜¯åœ¨å›è°ƒã€äº‹ä»¶å“åº”ï¼Œè¿˜æ˜¯å¹¶å‘ç¼–ç¨‹ä¸­ï¼Œlambda éƒ½è®©ä»£ç æ›´ç®€æ´ã€æ›´çµæ´»ã€‚

ä½†åœ¨å¤šçº¿ç¨‹åœºæ™¯ä¸­ï¼Œlambda çš„ä½¿ç”¨ä¹Ÿéšè—ç€ä¸å°‘å‘ï¼šå¼•ç”¨æ•è·æ‚¬ç©ºã€ç”Ÿå‘½å‘¨æœŸå¤±æ•ˆã€æ•è· this å´©æºƒã€çº¿ç¨‹å®‰å…¨é™·é˜±ç­‰ç­‰ã€‚

æœ¬ç¯‡å°†ç³»ç»Ÿæ¢³ç†ï¼š
1. lambda çš„åŸºæœ¬æœºåˆ¶
2. lambda åœ¨å¤šçº¿ç¨‹ä¸­çš„é«˜æ•ˆç”¨æ³•
3. å…¸å‹è¯¯ç”¨é™·é˜±ä¸æœ€ä½³å®è·µ
```

---

### âœ… äºŒã€lambda åŸºç¡€çŸ¥è¯†å›é¡¾

````markdown
#### 1. è¯­æ³•ç»“æ„

```cpp
[capture](parameters) mutable specifiers -> return_type {
    // body
};
````

* `capture`: æ•è·å¤–éƒ¨å˜é‡ï¼ˆå€¼ / å¼•ç”¨ï¼‰
* `mutable`: å…è®¸ä¿®æ”¹å€¼æ•è·çš„å‰¯æœ¬
* `-> return_type`: è¿”å›ç±»å‹ï¼ˆå¯çœç•¥ï¼‰
* `operator()`: éšå¼ç”Ÿæˆå‡½æ•°è°ƒç”¨æ¥å£

#### 2. ç¤ºä¾‹ï¼šåŸºç¡€ä½¿ç”¨

```cpp
int a = 10;
auto f = [a](int b) {
    return a + b;
};
std::cout << f(5);  // è¾“å‡º 15
```

#### 3. lambda æ˜¯ä»€ä¹ˆï¼Ÿ

lambda æœ¬è´¨æ˜¯ç¼–è¯‘å™¨ç”Ÿæˆçš„**åŒ¿åå‡½æ•°å¯¹è±¡**ï¼Œç±»ä¼¼ï¼š

```cpp
struct __lambda {
    int a;
    int operator()(int b) const { return a + b; }
};
```

å› æ­¤ï¼Œlambda æ˜¯ä¸€ç§**ä»¿å‡½æ•°ï¼ˆå‡½æ•°å¯¹è±¡ï¼‰**ã€‚

````

---

### âœ… ä¸‰ã€lambda åœ¨å¤šçº¿ç¨‹ä¸­çš„å…¸å‹åº”ç”¨

```markdown
#### 1. åœ¨çº¿ç¨‹ä»»åŠ¡ä¸­å†…è”ä»»åŠ¡é€»è¾‘

```cpp
std::thread t([]() {
    std::cout << "Hello from thread\n";
});
t.join();
````

æ— éœ€å†™å•ç‹¬çš„å‡½æ•°ï¼Œé€»è¾‘ç›´æ¥å°±åœ°å†…åµŒï¼Œæ–¹ä¾¿ä¼ å‚å’Œä¸Šä¸‹æ–‡çŠ¶æ€ç®¡ç†ã€‚

#### 2. æ•è·å˜é‡ä¼ é€’ä¸Šä¸‹æ–‡

```cpp
int id = 42;
std::thread t([id]() {
    std::cout << "Thread id: " << id << "\n";
});
t.join();
```

lambda å¯ä»¥æŒ‰å€¼æ•è·ä¸Šä¸‹æ–‡å˜é‡ï¼Œä¸ºçº¿ç¨‹ä»»åŠ¡æºå¸¦å‚æ•°ï¼Œä»£æ›¿ `std::bind` æ›´æ¸…æ™°ç›´è§‚ã€‚

````

---

### âœ… å››ã€å¤šçº¿ç¨‹åœºæ™¯ä¸‹çš„å¸¸è§å‘ç‚¹ âš ï¸

```markdown
#### âŒ 1. æ•è·å¼•ç”¨å¯¼è‡´æ‚¬ç©º

```cpp
std::thread t;
{
    int x = 100;
    t = std::thread([&]() {
        std::cout << x;  // âŒ x å·²ææ„ï¼ŒUB
    });
}
t.join();
````

âœ… è§£å†³æ–¹å¼ï¼šä½¿ç”¨å€¼æ•è· `[x]` æˆ– `shared_ptr` æ•è·ã€‚

---

#### âŒ 2. æ•è· thisï¼Œå¯¼è‡´å¯¹è±¡å·²ææ„åè®¿é—®æˆå‘˜

```cpp
class Task {
public:
    void run() {
        std::thread([this]() {
            std::cout << data;
        }).detach();
    }
private:
    int data = 123;
};
```

å¦‚æœ `Task` åœ¨ lambda æ‰§è¡Œå‰è¢«é”€æ¯ï¼Œå°†è®¿é—®æ‚¬ç©ºæŒ‡é’ˆã€‚

âœ… æ­£ç¡®æ–¹å¼ï¼š

```cpp
std::shared_ptr<Task> self = shared_from_this();
std::thread([self]() {
    std::cout << self->data;
}).detach();
```

---

#### âŒ 3. å¿˜è®° mutable æ— æ³•ä¿®æ”¹æ•è·å‰¯æœ¬

```cpp
int x = 10;
auto f = [x]() {
    x++;  // âŒ é”™è¯¯ï¼šx æ˜¯ const çš„
};
```

âœ… ä½¿ç”¨ `mutable`ï¼š

```cpp
auto f = [x]() mutable {
    x++;  // âœ… ä¿®æ”¹å‰¯æœ¬
};
```

````

---

### âœ… äº”ã€lambda æ•è·è¡Œä¸ºå…¨è§£ï¼ˆæ€»ç»“è¡¨ï¼‰

```markdown
| æ•è·æ–¹å¼      | è¯´æ˜                     | æ˜¯å¦èƒ½ä¿®æ”¹ | æ˜¯å¦å½±å“å¤–éƒ¨å˜é‡ |
|---------------|--------------------------|-------------|------------------|
| `[x]`         | å€¼æ•è·                   | âŒï¼ˆé»˜è®¤ï¼‰   | å¦               |
| `[x] mutable` | å€¼æ•è·ï¼Œå¯ä¿®æ”¹å‰¯æœ¬       | âœ…           | å¦               |
| `[&x]`        | å¼•ç”¨æ•è·                 | âœ…           | âœ…               |
| `[this]`      | æ•è·å½“å‰å¯¹è±¡             | âœ…           | âš ï¸ æ³¨æ„ç”Ÿå‘½å‘¨æœŸ |
| `[=, &y]`     | é»˜è®¤å€¼æ•è·ï¼Œç‰¹å®šå¼•ç”¨æ•è· | âœ…           | æ··åˆ             |
````

---

### âœ… å…­ã€ä¸çº¿ç¨‹æ± ã€å¼‚æ­¥ã€ä»»åŠ¡é˜Ÿåˆ—ç»“åˆ

````markdown
lambda åœ¨ä»»åŠ¡å¹¶å‘ç³»ç»Ÿä¸­å¹¿æ³›ç”¨äºï¼š

- å»¶è¿Ÿæ‰§è¡Œé€»è¾‘å°è£…
- å›è°ƒå‡½æ•°ä½“ä¼ å…¥
- å¼‚æ­¥ç»“æœå¤„ç†ï¼ˆé€šè¿‡ promise / futureï¼‰

ç¤ºä¾‹ï¼š

```cpp
std::function<void()> task = [p = std::move(ptr)]() {
    p->run();  // captured resource safely
};
````

ä»»åŠ¡é˜Ÿåˆ—åªéœ€å¤„ç† std::function\<void()>ï¼Œlambda è‡ªåŠ¨æ„é€ ã€æºå¸¦ä¸Šä¸‹æ–‡ã€‚

````

---

### âœ… ä¸ƒã€æœ€ä½³å®è·µæ€»ç»“

```markdown
- âœ… é»˜è®¤ä½¿ç”¨ `[x]` å€¼æ•è·ï¼Œé™¤éæ˜ç¡®éœ€è¦ä¿®æ”¹
- âœ… å¤šçº¿ç¨‹ä¸­è°¨æ…ä½¿ç”¨ `[&]`ï¼Œå¼•ç”¨æ•è·å¿…é¡»ç¡®ä¿ç”Ÿå‘½å‘¨æœŸå®‰å…¨
- âœ… æ•è· this æ—¶ä¼˜å…ˆ `[self = shared_from_this()]`
- âœ… æ•è· move-only å¯¹è±¡æ—¶æ˜¾å¼è½¬ç§»ï¼š`[p = std::move(ptr)]`
- âœ… ä½¿ç”¨ lambda æ›¿ä»£å†—é•¿çš„ bindï¼Œæ›´æ¸…æ™°æ›´å®‰å…¨
````

---

### âœ… å…«ã€ç»“è¯­

```markdown
C++ çš„ lambda ä¸åªæ˜¯è¯­æ³•ç³–ï¼Œå®ƒæœ¬è´¨ä¸Šæ˜¯ç°ä»£ C++ å¹¶å‘ç¼–ç¨‹ä¸­æœ€çµæ´»çš„å·¥å…·ä¹‹ä¸€ã€‚

åˆç†ä½¿ç”¨ lambdaï¼Œå¯ä»¥è®©çº¿ç¨‹ä»»åŠ¡çš„å°è£…æ›´ç®€æ´ã€æ›´å®‰å…¨ã€‚ä½†åŒæ—¶ä¹Ÿéœ€è¦ä½ å……åˆ†ç†è§£å…¶æ•è·è¡Œä¸ºå’Œç”Ÿå‘½å‘¨æœŸæœºåˆ¶ã€‚

æŒæ¡å®ƒï¼Œä¸åªæ˜¯è®©ä½ ä»£ç æ›´çŸ­ï¼Œè€Œæ˜¯æ›´å¥å£®ã€‚

æ¬¢è¿ç•™è¨€ä½ åœ¨é¡¹ç›®ä¸­é‡åˆ°è¿‡çš„ lambda é—®é¢˜ï¼Œä¸€èµ·æ¢è®¨ï¼
```

---

## âœ… é™„åŠ èµ„æºæ¨èï¼ˆå¯é€‰ï¼‰

```markdown
- [cppreference - lambda expressions](https://en.cppreference.com/w/cpp/language/lambda)
- Herb Sutter: â€œLambda: The good partsâ€
- ã€ŠEffective Modern C++ã€‹ Item 31â€“34
```

---


**lambda è¡¨è¾¾å¼åœ¨æ±‡ç¼–ä¸­å¹¶æ²¡æœ‰çœ‹åˆ°æ‰€è°“çš„â€œç”Ÿæˆç±»â€çš„ç»“æ„**ï¼Œè¿™å…¶å®æ¶‰åŠåˆ° C++ ç¼–è¯‘å™¨å¯¹ lambda çš„ **é—­åŒ…å¯¹è±¡ä¼˜åŒ–ã€å†…è”ã€ç±»å‹æ“¦é™¤ç­‰æœºåˆ¶**ï¼Œä¸‹é¢æˆ‘ä»¬ä»ç¼–è¯‘åŸç†å’Œä¼˜åŒ–çš„è§’åº¦ç³»ç»Ÿè§£é‡Šï¼š

---

## âœ… 1. ç†è®ºä¸Šï¼šlambda å°±æ˜¯ä¸€ä¸ªé—­åŒ…ç±»å¯¹è±¡

åœ¨ C++ è¯­ä¹‰ä¸Šï¼Œlambda æœ¬è´¨ä¸Šç­‰ä»·äºä¸€ä¸ª **ç¼–è¯‘å™¨è‡ªåŠ¨ç”Ÿæˆçš„ç±»ï¼ˆé—­åŒ…ç±»å‹ï¼‰+ ä¸€ä¸ªé‡è½½äº† `operator()` çš„å®ä¾‹**ï¼š

```cpp
auto f = [x](int y) { return x + y; };
```

ç­‰ä»·äºä¼ªä»£ç ï¼š

```cpp
struct __lambda_closure {
    int x;
    int operator()(int y) const { return x + y; }
};

__lambda_closure f = {x};
```

---

## âœ… 2. å®é™…ä¸Šï¼š**è¿™ä¸ªç±»åœ¨æ±‡ç¼–ä¸­â€œæ¶ˆå¤±â€äº†**

è¿™æ˜¯å› ä¸ºç°ä»£ç¼–è¯‘å™¨ï¼ˆå¦‚ GCCã€Clangã€MSVCï¼‰å¯¹ lambda åšäº†ä»¥ä¸‹ä¼˜åŒ–ï¼š

### âœ… ç¼–è¯‘å™¨è¡Œä¸ºï¼š

| è¡Œä¸º                   | æè¿°                             |
| -------------------- | ------------------------------ |
| âœ… å†…è”å±•å¼€ï¼ˆinliningï¼‰     | `operator()` ç›´æ¥å±•å¼€åˆ°è°ƒç”¨å¤„ï¼Œæ— éœ€å‡½æ•°å¯¹è±¡å­˜åœ¨ |
| âœ… ä¼˜åŒ–æ‰ç±»å‹              | lambda çš„ç±»å‹æ˜¯ **å”¯ä¸€æ— åç±»å‹**ï¼Œåªåœ¨ç¼–è¯‘æœŸå­˜åœ¨ |
| âœ… æ ˆä¸Šå¸ƒå±€ä¼˜åŒ–             | æ•è·å˜é‡å½“ä½œå‚æ•°æˆ–æ ˆç©ºé—´åˆ†é…ï¼Œä¸å•ç‹¬å®šä¹‰ç±»ç»“æ„        |
| âœ… æ— çŠ¶æ€ lambda ä¼˜åŒ–ä¸ºå‡½æ•°æŒ‡é’ˆ | è‹¥ lambda ä¸æ•è·å˜é‡ï¼Œç›´æ¥é™çº§ä¸ºæ™®é€šå‡½æ•°æŒ‡é’ˆ     |

---

## âœ… 3. ä¸ºä»€ä¹ˆä½ åœ¨æ±‡ç¼–é‡Œçœ‹ä¸åˆ°ç±»ç»“æ„ï¼Ÿ

å› ä¸ºï¼š

* ç¼–è¯‘å™¨å·²ç»å°† lambda çš„ operator() é€»è¾‘ **ç›´æ¥å†…è”** åˆ°è°ƒç”¨ä½ç½®ï¼›
* æ•è·çš„å˜é‡è¢«å½“ä½œæ™®é€šæ ˆå˜é‡å¤„ç†ï¼Œ**ä¸ä¼šæ„é€ çœŸå®çš„ç±»å¯¹è±¡ç»“æ„**ï¼›
* å¯¹äºç®€å• lambdaï¼Œ**æ ¹æœ¬ä¸ä¼šç”Ÿæˆç‹¬ç«‹çš„é—­åŒ…ç»“æ„**ï¼Œåªæ˜¯ä¸€ä¸ªä¸´æ—¶çš„è°ƒç”¨é€»è¾‘å—ã€‚

---

## âœ… 4. ä¸¾ä¾‹è¯´æ˜ï¼šå¸¦æ•è· vs ä¸å¸¦æ•è·

### âœ… ä¸å¸¦æ•è·çš„ lambda

```cpp
auto f = [](int x) { return x + 1; };
f(10);
```

* ç¼–è¯‘å™¨ç›´æ¥ç”Ÿæˆä¸€ä¸ªå†…éƒ¨å‡½æ•°ï¼ˆé™æ€æˆ–å±€éƒ¨ï¼‰ï¼Œç±»ä¼¼ `__lambda_fn(int)`ï¼›
* lambda å¯ä»¥éšå¼è½¬æ¢ä¸ºå‡½æ•°æŒ‡é’ˆï¼›
* æ±‡ç¼–ä¸­æ˜¯æ™®é€šå‡½æ•°è°ƒç”¨ã€‚

### âœ… å¸¦æ•è· lambda

```cpp
int a = 5;
auto f = [a](int x) { return x + a; };
f(10);
```

* ç¼–è¯‘å™¨ä¼šå°† `a` å­˜å‚¨åœ¨ä¸€ä¸ªä¸´æ—¶é—­åŒ…å¯¹è±¡ä¸­ï¼ˆæ ˆä¸Šå˜é‡ï¼‰ï¼›
* `operator()` å¯èƒ½è¢«å†…è”ï¼›
* æ±‡ç¼–ä¸­ä½ çœ‹åˆ°çš„åªæ˜¯å°† `a` å’Œ `x` åŠ æ³•çš„æœºå™¨æŒ‡ä»¤ï¼Œæ²¡æœ‰ç±»ã€æ–¹æ³•åç­‰ç»“æ„ã€‚

---

## âœ… 5. ç¼–è¯‘å™¨å¦‚ä½•å¤„ç†é—­åŒ…å¯¹è±¡

ä½ å¯ä»¥ç”¨ `clang++ -Xclang -ast-dump` å‘½ä»¤æŸ¥çœ‹ ASTï¼Œçœ‹åˆ°ç±»ä¼¼ï¼š

```
CXXRecordDecl <lambda at main.cpp:4:13> class definition
 |-FieldDecl x
 |-CXXMethodDecl operator()
```

è¯´æ˜ç¡®å®ç”Ÿæˆäº†ä¸€ä¸ªç±»ç±»å‹ï¼Œåªæ˜¯ï¼š

* ç¼–è¯‘æœŸå°±åœ°æ¶ˆè§£ï¼›
* æ— éœ€åœ¨æœ€ç»ˆç›®æ ‡ä»£ç ä¸­ä¿ç•™ç±»å‹ä¿¡æ¯ã€‚

---

## âœ… 6. åä¾‹ï¼šç”¨ `typeid` æŸ¥çœ‹ lambda çš„ç±»å‹å

```cpp
#include <iostream>
#include <typeinfo>

int main() {
    auto l = [](int x) { return x * 2; };
    std::cout << typeid(l).name() << "\n";
}
```

ä½ ä¼šçœ‹åˆ°ç±»ä¼¼ï¼š

```
main::$_0
```

æˆ–ï¼š

```
lambda_main_0
```

è¯´æ˜ï¼šlambda **ç¡®å®æ˜¯æœ‰ç±»å‹çš„é—­åŒ…ç±»å¯¹è±¡**ï¼Œä½†è¿™ä¸ªç±»å‹æ˜¯åŒ¿åçš„ã€åªåœ¨ç¼–è¯‘æœŸç”Ÿæ•ˆã€‚

---

## âœ… 7. æ€»ç»“ä¸€å¼ å›¾ï¼ˆé€»è¾‘ vs å®ç°ï¼‰

| å±‚çº§ | ç†è§£è§’åº¦     | è¡Œä¸º                            |
| -- | -------- | ----------------------------- |
| è¯­ä¹‰ | C++ è¯­è¨€å±‚é¢ | lambda æ˜¯é—­åŒ…ç±»çš„å®ä¾‹ï¼Œæœ‰ `operator()` |
| ç¼–è¯‘ | ç¼–è¯‘å™¨å¤„ç†    | lambda ç±»å‹å”¯ä¸€æ— åï¼Œå¯æ¨¡æ¿æ¨å¯¼ï¼Œæ— éœ€ä½ å£°æ˜     |
| ä¼˜åŒ– | æ±‡ç¼–/æœºå™¨ç å±‚é¢ | ç¼–è¯‘å™¨ä¼˜åŒ–æ‰ç»“æ„ä½“ï¼Œç›´æ¥å†…è”é€»è¾‘ï¼Œå˜é‡å½“ä½œå€¼å‹æ ˆä¼ é€’ç­‰   |

---

## âœ… 8. ç»“è®º

> è™½ç„¶æˆ‘ä»¬åœ¨â€œç†è§£â€lambda æ—¶å¯ä»¥æŠŠå®ƒçœ‹ä½œæ˜¯ç”Ÿæˆäº†ä¸€ä¸ªç±»ï¼Œä½†å®é™…ç¼–è¯‘å™¨å¾€å¾€ä¼šå°†å®ƒå†…è”å±•å¼€ä¼˜åŒ–æ‰ï¼Œä½¿å¾—ä½ åœ¨æ±‡ç¼–å±‚çº§æ— æ³•ç›´æ¥çœ‹åˆ°æ‰€è°“çš„â€œç±»ç»“æ„â€ã€‚

è¿™å¹¶ä¸ä»£è¡¨ lambda æ²¡æœ‰ç±»æœ¬è´¨ï¼Œè€Œæ˜¯è¯´æ˜ **ç¼–è¯‘å™¨éå¸¸èªæ˜ï¼Œåœ¨ä¿è¯è¯­ä¹‰æ­£ç¡®çš„å‰æä¸‹ï¼Œæœ€å¤§é™åº¦å‹ç¼©ç»“æ„å¼€é”€ã€‚**

---

è¿›ä¸€æ­¥æ‹“å±•ï¼š

* lambda çš„æ±‡ç¼–ä»£ç å¯¹æ¯”ï¼ˆå¸¦æ•è· vs ä¸å¸¦æ•è·ï¼‰
* å¦‚ä½•æ‰‹åŠ¨è§‚å¯Ÿ lambda è¢«å±•å¼€çš„ä¸­é—´ä»£ç ï¼ˆå¦‚ç”¨ `-S -O2` + `objdump`ï¼‰
* lambda ä¸é—­åŒ…åœ¨æ€§èƒ½ä¼˜åŒ–ä¸­çš„åº”ç”¨ï¼ˆé›¶å¼€é”€æŠ½è±¡ï¼‰


**lambda è¡¨è¾¾å¼åœ†æ‹¬å·å†…çš„å…¥å‚ï¼ˆå‚æ•°åˆ—è¡¨ï¼‰æ˜¯å¯ä»¥ä¿®æ”¹çš„**ï¼Œåªè¦è¿™äº›å‚æ•°ä¸æ˜¯è¢«å£°æ˜ä¸º `const`ï¼Œä½ å°±å¯ä»¥åœ¨ lambda å‡½æ•°ä½“å†…è‡ªç”±ä¿®æ”¹å®ƒä»¬ã€‚

---

## âœ… ç¤ºä¾‹ 1ï¼šä¿®æ”¹å…¥å‚

```cpp
auto f = [](int x) {
    x += 10;
    std::cout << x << std::endl;
};

f(5);  // è¾“å‡º 15
```

* è¿™é‡Œ `x` æ˜¯ **æŒ‰å€¼ä¼ é€’** çš„å‡½æ•°å‚æ•°ï¼›
* ä½ å¯ä»¥ä¿®æ”¹å®ƒï¼Œå› ä¸ºå®ƒæ˜¯ä½ å‡½æ•°å†…éƒ¨çš„å±€éƒ¨å˜é‡ã€‚

---

## âœ… ç¤ºä¾‹ 2ï¼šå…¥å‚æ˜¯å¼•ç”¨ï¼Œä¿®æ”¹ä¼šå½±å“å¤–éƒ¨å˜é‡

```cpp
int y = 10;
auto f = [](int& x) {
    x += 5;
};

f(y);
std::cout << y << std::endl;  // è¾“å‡º 15
```

* å…¥å‚ `x` æ˜¯å¼•ç”¨ï¼Œä¿®æ”¹å½±å“å¤–éƒ¨ã€‚

---

## âœ… ç¤ºä¾‹ 3ï¼šæ˜¾å¼åŠ ä¸Š `const` åˆ™ä¸èƒ½ä¿®æ”¹

```cpp
auto f = [](const int x) {
    // x += 5;  // âŒ ç¼–è¯‘é”™è¯¯ï¼šx æ˜¯ const
};
```

---

## âœ… ç»“è®ºæ€»ç»“

| å½¢å¼                    | æ˜¯å¦å¯ä»¥ä¿®æ”¹   | è¯´æ˜              |
| --------------------- | -------- | --------------- |
| `[](int x) { x++; }`  | âœ… å¯ä¿®æ”¹å‰¯æœ¬  | ä¼ å€¼ï¼Œå†…éƒ¨æ˜¯å±€éƒ¨å˜é‡      |
| `[](int& x) { x++; }` | âœ… ä¿®æ”¹åŸå§‹å˜é‡ | ä¼ å¼•ç”¨ï¼Œå½±å“å¤–éƒ¨        |
| `[](const int x)`     | âŒ ä¸å¯ä¿®æ”¹   | æ˜ç¡®å£°æ˜ constï¼Œé™åˆ¶ä¿®æ”¹ |

---

## âœ… âš ï¸ ä¸ lambda æ•è·æ— å…³

æ³¨æ„ï¼š

> lambda å‚æ•°åˆ—è¡¨å†…çš„å‚æ•°å’Œ `[]` æ•è·åˆ—è¡¨é‡Œçš„å˜é‡**æ˜¯ä¸¤ä¸ªå®Œå…¨ç‹¬ç«‹çš„æœºåˆ¶**ã€‚

* å‚æ•°åˆ—è¡¨æ˜¯æ˜¾å¼ä¼ å…¥ lambda çš„å‚æ•°ï¼›
* æ•è·åˆ—è¡¨æ˜¯å°†ä½œç”¨åŸŸå¤–éƒ¨çš„å˜é‡â€œé—­åŒ…è¿›æ¥â€ã€‚

å®ƒä»¬ä½œç”¨åŸŸä¸åŒï¼Œç”Ÿå‘½å‘¨æœŸä¹Ÿä¸åŒã€‚

---

## âœ… ç¤ºä¾‹ï¼šæ•è·å’Œå‚æ•°åˆ†å¼€çœ‹

```cpp
int a = 5;
auto f = [a](int x) mutable {
    x += a;  // å‚æ•° x å¯ä¿®æ”¹ï¼Œæ•è·å˜é‡ a ä¹Ÿæ˜¯å‰¯æœ¬ï¼Œå¯ä¿®æ”¹
    a = 100; // ä¿®æ”¹ a å‰¯æœ¬ï¼Œä¸å½±å“å¤–éƒ¨
};
f(3);
```

---

å½“ç„¶å¯ä»¥ï¼ä»¥ä¸‹æ˜¯ **C++ Lambda è¡¨è¾¾å¼å®Œæ•´ä»‹ç»çš„ PPT å†…å®¹å¤§çº²ä¸æ¯é¡µå†…å®¹è‰ç¨¿**ï¼Œä½ å¯ä»¥ç›´æ¥å¤åˆ¶è¿› PowerPoint æˆ– Keynote ä½¿ç”¨ï¼Œä¹Ÿå¯è½¬æ¢ä¸º PDF æ¼”ç¤ºæ–‡æ¡£ã€‚

---

## ğŸ¯ æ¼”ç¤ºæ ‡é¢˜å»ºè®®ï¼š

**ã€Šç°ä»£ C++ Lambda è¡¨è¾¾å¼å…¨è§£ï¼šæœºåˆ¶ã€ç”¨æ³•ä¸å¤šçº¿ç¨‹å®æˆ˜ã€‹**

---

## ğŸ§± PPT æ€»ä½“ç»“æ„ï¼ˆå…± 12 é¡µï¼‰ï¼š

1. å°é¢
2. ä»€ä¹ˆæ˜¯ Lambda è¡¨è¾¾å¼ï¼Ÿ
3. Lambda çš„è¯­æ³•ç»“æ„
4. æ•è·æ–¹å¼è¯¦è§£
5. Lambda æ˜¯ä»€ä¹ˆç±»å‹ï¼Ÿ
6. mutable å…³é”®å­—è¯´æ˜
7. Lambda ä¸å¤šçº¿ç¨‹çš„ç»“åˆ
8. å¤šçº¿ç¨‹ä¸‹çš„å…¸å‹è¯¯ç”¨ä¸é£é™©
9. Lambda çš„æ€§èƒ½ä¸ä¼˜åŒ–åˆ†æ
10. Lambda vs ä»¿å‡½æ•° vs å‡½æ•°æŒ‡é’ˆ
11. é¡¹ç›®å®æˆ˜åº”ç”¨åœºæ™¯
12. æ€»ç»“ä¸å»ºè®®

---

### âœ… ç¬¬ 1 é¡µï½œå°é¢

**æ ‡é¢˜ï¼š**

> ç°ä»£ C++ Lambda è¡¨è¾¾å¼å…¨è§£
> â€”â€” æœºåˆ¶ã€ç”¨æ³•ä¸å¤šçº¿ç¨‹å®æˆ˜

**å‰¯æ ‡é¢˜ï¼š**
ä¸»è®²äºº / æ—¥æœŸ / å…¬å¸åç§°ï¼ˆå¯è‡ªå®šä¹‰ï¼‰

---

### âœ… ç¬¬ 2 é¡µï½œä»€ä¹ˆæ˜¯ Lambda è¡¨è¾¾å¼ï¼Ÿ

> Lambda è¡¨è¾¾å¼æ˜¯ C++11 å¼•å…¥çš„åŒ¿åå‡½æ•°æœºåˆ¶ï¼Œç”¨äºå°±åœ°å®šä¹‰å¯è°ƒç”¨å¯¹è±¡ï¼Œå¸¸ç”¨äº STL ç®—æ³•ã€å›è°ƒã€å¹¶å‘ä»»åŠ¡ç­‰åœºæ™¯ã€‚

**ç‰¹æ€§ï¼š**

* æ²¡æœ‰åå­—ï¼ˆåŒ¿åå‡½æ•°å¯¹è±¡ï¼‰
* å¯æ•è·ä½œç”¨åŸŸå¤–å˜é‡ï¼ˆé—­åŒ…ï¼‰
* å¯æ›¿ä»£å‡½æ•°æŒ‡é’ˆ / ä»¿å‡½æ•° / bind

**ç¤ºä¾‹ï¼š**

```cpp
auto add = [](int a, int b) {
    return a + b;
};
add(3, 4); // è¾“å‡º 7
```

---

### âœ… ç¬¬ 3 é¡µï½œLambda çš„è¯­æ³•ç»“æ„

```cpp
[capture](parameters) mutable specifiers -> return_type {
    body;
};
```

**è¯´æ˜ï¼š**

* `capture`ï¼šæ•è·å¤–éƒ¨å˜é‡ï¼ˆå€¼/å¼•ç”¨/ç»“æ„ç»‘å®šï¼‰
* `parameters`ï¼šå‡½æ•°å‚æ•°
* `mutable`ï¼šå…è®¸ä¿®æ”¹å€¼æ•è·çš„å‰¯æœ¬
* `return_type`ï¼šè¿”å›ç±»å‹ï¼ˆå¯æ¨å¯¼ï¼‰
* `body`ï¼šå‡½æ•°ä½“

---

### âœ… ç¬¬ 4 é¡µï½œæ•è·æ–¹å¼è¯¦è§£

| æ•è·å½¢å¼      | å«ä¹‰               | ç¤ºä¾‹            |
| --------- | ---------------- | ------------- |
| `[=]`     | å€¼æ•è·å…¨éƒ¨å¤–éƒ¨å˜é‡        | `[=]() {}`    |
| `[&]`     | å¼•ç”¨æ•è·å…¨éƒ¨å¤–éƒ¨å˜é‡       | `[&]() {}`    |
| `[x]`     | å€¼æ•è· x            | `[x]() {}`    |
| `[&x]`    | å¼•ç”¨æ•è· x           | `[&x]() {}`   |
| `[=, &y]` | é»˜è®¤å€¼æ•è·ï¼Œä½† y å¼•ç”¨æ•è·   |               |
| `[this]`  | æ•è·å½“å‰å¯¹è±¡æŒ‡é’ˆï¼ˆéšå¼è®¿é—®æˆå‘˜ï¼‰ | `[this]() {}` |

**è¯´æ˜ï¼š**

* å€¼æ•è·é»˜è®¤æ˜¯ `const`
* å¼•ç”¨æ•è·éœ€æ³¨æ„ç”Ÿå‘½å‘¨æœŸ

---

### âœ… ç¬¬ 5 é¡µï½œLambda æ˜¯ä»€ä¹ˆç±»å‹ï¼Ÿ

> Lambda æ˜¯ç¼–è¯‘å™¨è‡ªåŠ¨ç”Ÿæˆçš„â€œé—­åŒ…ç±»â€çš„å®ä¾‹ï¼Œå¸¦æœ‰ `operator()`ã€‚

* ç¼–è¯‘æ—¶ç”Ÿæˆå”¯ä¸€åŒ¿åç±»å‹
* æ”¯æŒæ‹·è´æ„é€ ã€è°ƒç”¨è¿ç®—ç¬¦
* å¯èµ‹å€¼ç»™ `auto` æˆ– `std::function`

**ç¤ºä¾‹ä¼ªä»£ç ï¼š**

```cpp
struct __lambda {
    int x;
    int operator()(int y) const { return x + y; }
};
```

---

### âœ… ç¬¬ 6 é¡µï½œmutable å…³é”®å­—

> é»˜è®¤æƒ…å†µä¸‹ï¼Œå€¼æ•è·å˜é‡åœ¨ `operator()` ä¸­æ˜¯ `const` çš„ã€‚`mutable` å…è®¸ä¿®æ”¹å‰¯æœ¬ã€‚

**ç¤ºä¾‹ï¼š**

```cpp
int a = 10;
auto f = [a]() mutable {
    a += 5; // âœ… OK
};
```

**æ³¨æ„ï¼š**

* ä¿®æ”¹çš„æ˜¯å‰¯æœ¬ï¼Œä¸å½±å“åŸå§‹å˜é‡
* ä»…å¯¹å€¼æ•è·å˜é‡æœ‰æ•ˆ

---

### âœ… ç¬¬ 7 é¡µï½œLambda ä¸å¤šçº¿ç¨‹ç»“åˆ

> Lambda æ˜¯æ„å»ºå¹¶å‘é€»è¾‘çš„é‡è¦å·¥å…·ï¼Œé€‚åˆç”¨äºï¼š

* ä»»åŠ¡å°è£…
* å›è°ƒç»‘å®š
* å»¶è¿Ÿæ‰§è¡Œé€»è¾‘ä¼ é€’

**ç¤ºä¾‹ï¼š**

```cpp
int id = 42;
std::thread t([id]() {
    std::cout << id;
});
t.join();
```

**ä¼˜åŠ¿ï¼š**

* ç»“æ„ç´§å‡‘
* æ•è·ä¸Šä¸‹æ–‡çµæ´»
* å¯ä¼ é€’çŠ¶æ€

---

### âœ… ç¬¬ 8 é¡µï½œå¤šçº¿ç¨‹ä¸‹çš„è¯¯ç”¨ä¸é™·é˜± âš ï¸

| è¯¯ç”¨ç±»å‹         | åæœ            | æ­£ç¡®åšæ³•                          |
| ------------ | ------------- | ----------------------------- |
| `[&]` æ•è·æ‚¬ç©ºå˜é‡ | å¤–éƒ¨å˜é‡ç”Ÿå‘½å‘¨æœŸç»“æŸåè®¿é—® | ä½¿ç”¨ `[x]` æˆ– `shared_ptr`       |
| `[this]` å¤±æ•ˆ  | å¯¹è±¡ææ„åè®¿é—®é‡æŒ‡é’ˆ    | `[self = shared_from_this()]` |
| å¿˜è®° mutable   | æ— æ³•ä¿®æ”¹å€¼æ•è·       | æ˜¾å¼åŠ  `mutable`                 |

---

### âœ… ç¬¬ 9 é¡µï½œLambda æ€§èƒ½ä¸ä¼˜åŒ–

* âœ… æ”¯æŒå†…è”ï¼Œç¼–è¯‘å™¨å¯çœç•¥é—­åŒ…ç»“æ„
* âœ… éæ•è· lambda å¯è½¬ä¸ºå‡½æ•°æŒ‡é’ˆ
* âœ… é›¶åŠ¨æ€å†…å­˜å¼€é”€ï¼ˆæ—  std::functionï¼‰
* âš ï¸ é¿å…å¤§é‡æ•è·å‰¯æœ¬å¯¼è‡´æ‹·è´ä»£ä»·é«˜

**å»ºè®®ï¼š**

* æ€§èƒ½æ•æ„Ÿè·¯å¾„å°½é‡ä½¿ç”¨éæ•è· lambda
* ä½¿ç”¨ `std::move` æ•è·ç‹¬å èµ„æºæ—¶åº”æ³¨æ„

---

### âœ… ç¬¬ 10 é¡µï½œLambda vs ä»¿å‡½æ•° vs å‡½æ•°æŒ‡é’ˆ

| ç‰¹æ€§        | Lambda       | ä»¿å‡½æ•°      | å‡½æ•°æŒ‡é’ˆ    |
| --------- | ------------ | -------- | ------- |
| å¯æ•è·å¤–éƒ¨å˜é‡   | âœ…            | âœ…        | âŒ       |
| æ”¯æŒçŠ¶æ€æºå¸¦    | âœ…            | âœ…        | âŒ       |
| å†…è”ä¼˜åŒ–      | âœ…            | éƒ¨åˆ†æ”¯æŒ     | âœ…       |
| å¤šæ€æ€§       | âœ…ï¼ˆæ³›å‹ lambdaï¼‰ | âœ…ï¼ˆæ¨¡æ¿ä»¿å‡½æ•°ï¼‰ | âŒ       |
| é€‚ç”¨ STL ç®—æ³• | âœ…            | âœ…        | â­• å¯ç”¨ä½†å±€é™ |

---

### âœ… ç¬¬ 11 é¡µï½œé¡¹ç›®å®æˆ˜åº”ç”¨åœºæ™¯

* âœ… å¤šçº¿ç¨‹ä»»åŠ¡æŠ•é€’ï¼ˆå¦‚çº¿ç¨‹æ± ã€std::threadï¼‰
* âœ… GUI å›è°ƒç»‘å®šï¼ˆå¦‚ Qt / ImGuiï¼‰
* âœ… å¼‚æ­¥ä»»åŠ¡å¤„ç†ï¼ˆå¦‚ `std::async`, `future`ï¼‰
* âœ… STL ç®—æ³•ç®€åŒ–æ’åº/è¿‡æ»¤é€»è¾‘
* âœ… äº‹ä»¶åˆ†å‘ & è®¢é˜…-å‘å¸ƒç³»ç»Ÿä¸­å°è£…å›è°ƒ

---

### âœ… ç¬¬ 12 é¡µï½œæ€»ç»“ä¸å»ºè®®

* Lambda æ˜¯ç°ä»£ C++ ç¼–ç¨‹çš„æ ¸å¿ƒç‰¹æ€§ä¹‹ä¸€
* å®ƒæä¾›äº†å‡½æ•°å¼ç¼–ç¨‹çš„çµæ´»æ€§ä¸æ€§èƒ½å…¼é¡¾çš„å°è£…èƒ½åŠ›
* å¤šçº¿ç¨‹ä¸­è¦ç‰¹åˆ«æ³¨æ„ï¼šå¼•ç”¨æ•è· & ç”Ÿå‘½å‘¨æœŸ
* æ¨èå¤šç”¨ lambda æ›¿ä»£ bindã€è£¸å‡½æ•°æŒ‡é’ˆã€ä»¿å‡½æ•°

> ç†Ÿç»ƒä½¿ç”¨ lambdaï¼Œæ˜¯è¿ˆå…¥ç°ä»£ C++ çš„é‡è¦ä¸€æ­¥ï¼

---


åœ¨æ•è·åˆ—è¡¨é‡Œ**åªå†™å‡ºä½ éœ€è¦æŒ‰å€¼æ•è·çš„å˜é‡**å³å¯ï¼Œç»ä¸è¦ä¸ºäº†â€œæ–¹ä¾¿â€ä½¿ç”¨ `[=]` æŠŠæ‰€æœ‰å¤–éƒ¨å˜é‡å…¨æŠ“è¿›æ¥ã€‚

```cpp
int a = 1, b = 2, c = 3;
// åªæƒ³æŒ‰å€¼æ•è· aã€cï¼š
auto f1 = [a, c]() {
    // è¿™é‡Œå¯ä»¥è¯» aã€c çš„å‰¯æœ¬ï¼Œä½†ä¸èƒ½ä¿®æ”¹ï¼ˆé™¤éåŠ  mutableï¼‰
    std::cout << "a=" << a << ", c=" << c << "\n";
};

// å¦‚æœä½ æƒ³åœ¨æ•è·çš„æ—¶å€™å¯¹è¡¨è¾¾å¼æ±‚å€¼ï¼ˆC++14+ï¼‰ï¼Œä¹Ÿå¯ä»¥è¿™æ ·å†™ï¼š
auto ptr = std::make_unique<Foo>();
auto f2 = [x = compute(), ptr = std::move(ptr)]() {
    // x æ˜¯ compute() çš„è¿”å›å€¼å‰¯æœ¬
    // ptr æ˜¯ç‹¬å å¼åœ°ç§»åŠ¨è¿›æ¥çš„ unique_ptr
    ptr->doSomething(x);
};
```

---

### ä¸ºä»€ä¹ˆæ¨èæ˜¾ç¤ºåˆ—å‡ºè¦æ•è·çš„å˜é‡ï¼Ÿ

1. **å¯ç»´æŠ¤æ€§**ï¼šä¸€çœ¼å°±èƒ½çœ‹å‡º lambda ä¾èµ–äº†å“ªäº›å¤–éƒ¨çŠ¶æ€ã€‚
2. **æ€§èƒ½å¯æ§**ï¼šé¿å…æ— æ„é—´æ‹·è´å¤§å¯¹è±¡ã€‚
3. **å®‰å…¨æ€§**ï¼šé¿å…æŠŠä¸´æ—¶å¯¹è±¡ã€æŒ‡é’ˆã€ç”Ÿå‘½å‘¨æœŸçŸ­çš„å˜é‡ä¹Ÿæ•è·è¿›æ¥ã€‚

---

### å°ç»“

* **åªæ•è·å¿…è¦çš„å˜é‡**ï¼š`[a, b]`ã€`[x, y, z]`
* **æ•è·è¡¨è¾¾å¼ï¼ˆC++14ï¼‰**ï¼š`[v = expr(), p = std::move(ptr)]`
* **ä¸è¦æ»¥ç”¨** `[=]` å’Œ `[&]`ï¼Œæ‰‹åŠ¨åˆ—å‡ºèƒ½è®©ä»£ç æ›´æ¸…æ™°ã€æ›´å¥å£®ã€‚


ä¸‹é¢æ˜¯åœ¨â€œå¤šçº¿ç¨‹ä¸‹çš„è¯¯ç”¨ä¸é™·é˜±â€ä¸­ï¼Œä¸“é—¨æ–°å¢ä¸€èŠ‚â€œæ‚¬ç©ºå¼•ç”¨ï¼ˆDangling Referenceï¼‰â€çš„è¯¦ç»†å±•å¼€ï¼ŒåŒ…å«å¤šç§å…¸å‹æ¡ˆä¾‹åŠè§£å†³æ–¹æ¡ˆï¼Œä½ å¯ä»¥ç›´æ¥æ’å…¥åˆ°ç¬¬ 8 é¡µæˆ–ä½œä¸ºé™„åŠ é¡µä½¿ç”¨ã€‚

---

### âš ï¸ å¤šçº¿ç¨‹åœºæ™¯ä¸‹çš„å…¸å‹ã€æ‚¬ç©ºå¼•ç”¨ã€‘æ¡ˆä¾‹

> **æ‚¬ç©ºå¼•ç”¨**ï¼šlambda æ•è·äº†ä¸€ä¸ªå¼•ç”¨ï¼Œä½†è¢«æ•è·çš„å¯¹è±¡åœ¨ lambda æ‰§è¡Œå‰å·²é”€æ¯ï¼Œå¯¼è‡´ undefined behaviorï¼ˆUBï¼‰ã€‚

---

#### 1. æ•è·æ ˆä¸Šå±€éƒ¨å˜é‡

```cpp
std::thread t;
{
    int x = 100;
    // [&] ä¼šå¼•ç”¨ x
    t = std::thread([&]() {
        // x å·²ç» out-of-scope â€”â€” æ‚¬ç©ºå¼•ç”¨
        std::cout << x << "\n";  
    });
}   // x åœ¨æ­¤å¤„è¢«é”€æ¯
t.join();  // UB
```

**è§£å†³**ï¼šæŒ‰å€¼æ•è· `x` æˆ–ç”¨æ™ºèƒ½æŒ‡é’ˆå°è£…ï¼š

```cpp
std::thread t;
{
    int x = 100;
    t = std::thread([x]() { std::cout << x << "\n"; });
}
t.join();
```

---

#### 2. æ•è·ä¸´æ—¶å¯¹è±¡ / å³å€¼

```cpp
std::thread t = std::thread([&]() {
    std::string s = "hello";
    std::this_thread::sleep_for(1s);
    std::cout << s << "\n";
});
t.join();
```

ä¸Šé¢è™½æœªå†™é”™ï¼Œè‹¥æ”¹ä¸ºï¼š

```cpp
std::thread t = std::thread([&]() {
    auto s = std::to_string(123);
    // ...
});
```

è¿™é‡Œæ•è·çš„ `&s` åªæ˜¯å±€éƒ¨ä¸´æ—¶ï¼Œçº¿ç¨‹ä½“è®¿é—®åŒæ ·æ‚¬ç©ºã€‚

**è§£å†³**ï¼šæŒ‰å€¼æ•è·æˆ–å…ˆä¿å­˜åœ¨å¤–éƒ¨å˜é‡ï¼š

```cpp
auto s = std::to_string(123);
std::thread t([s]() { std::cout << s << "\n"; });
t.join();
```

---

#### 3. å¾ªç¯ä¸­æ•è·å¾ªç¯å˜é‡ï¼ˆå¸¸è§äºçº¿ç¨‹æ± æˆ–å¹¶å‘å¯åŠ¨å¤šçº¿ç¨‹ï¼‰

```cpp
std::vector<std::thread> workers;
for (int i = 0; i < 5; ++i) {
    // [&i] å„çº¿ç¨‹éƒ½å¼•ç”¨åŒä¸€ä¸ª i
    workers.emplace_back([&]() {
        std::cout << "worker " << i << "\n";  // æœ€ç»ˆæ¯ä¸ªéƒ½æ‰“å° 5
    });
}
for (auto& t : workers) t.join();
```

**è§£å†³**ï¼šæŒ‰å€¼æ•è·æ¯æ¬¡è¿­ä»£çš„ iï¼š

```cpp
for (int i = 0; i < 5; ++i) {
    workers.emplace_back([i]() {
        std::cout << "worker " << i << "\n";
    });
}
```

---

#### 4. æ•è· `this` å¯¼è‡´æ‚¬ç©º

```cpp
class Server {
public:
    void start() {
        std::thread([this]() {
            // sleep åå¯èƒ½ this å·²è¢«é”€æ¯
            std::this_thread::sleep_for(1s);
            handle();
        }).detach();
    }
    void handle() { /* ... */ }
    ~Server() { /* èµ„æºé‡Šæ”¾ */ }
};
```

å¦‚æœ `Server` åœ¨å­çº¿ç¨‹æ‰§è¡Œå‰ææ„ï¼Œåˆ™ `this` æˆä¸ºæ‚¬ç©ºã€‚

**è§£å†³**ï¼šç”¨ `shared_from_this()` å»¶é•¿ç”Ÿå‘½å‘¨æœŸï¼š

```cpp
class Server : public std::enable_shared_from_this<Server> {
public:
    void start() {
        auto self = shared_from_this();
        std::thread([self]() {
            std::this_thread::sleep_for(1s);
            self->handle();
        }).detach();
    }
    // ...
};
```

---

#### 5. æ•è·å®¹å™¨å¼•ç”¨åä¿®æ”¹å®¹å™¨

```cpp
std::vector<int> data = {1,2,3};
std::thread t([&data]() {
    // ä¸»çº¿ç¨‹è‹¥åœ¨æ­¤å¤„æ¸…ç©ºæˆ–é”€æ¯ dataï¼Œå°±æ‚¬ç©º
    for (auto v : data) std::cout << v;
});
data.clear();  // data ç©ºæˆ–ææ„
t.join();      // UB
```

**è§£å†³**ï¼šæŒ‰å€¼æ•è·æ•´ä¸ªå®¹å™¨æˆ–æå‰åšæ‹·è´ï¼š

```cpp
std::thread t([data]() mutable {
    for (auto v : data) std::cout << v;
});
data.clear();
t.join();
```

---

#### 6. æ•è·ç§»åŠ¨-only å¯¹è±¡å¼•ç”¨

```cpp
auto ptr = std::make_unique<Foo>();
std::thread t([&ptr]() {
    ptr->doWork();  // å¦‚æœä¸»çº¿ç¨‹ç§»èµ°æˆ–é”€æ¯ ptrï¼Œåˆ™æ‚¬ç©º
});
ptr.reset();
t.join();  // UB
```

**è§£å†³**ï¼šç”¨ç§»åŠ¨æ•è·ï¼ˆC++14ï¼‰ï¼š

```cpp
std::thread t([ptr = std::move(ptr)]() mutable {
    ptr->doWork();
});
t.join();
```

---

### ğŸ”‘ å°ç»“

1. **å¼•ç”¨æ•è·ï¼ˆ`&`ï¼‰åœ¨å¤šçº¿ç¨‹ä¸­æœ€å±é™©**ï¼Œå‡¡æ•è·å¼•ç”¨éƒ½éœ€ç¡®ä¿è¢«æ•è·å¯¹è±¡çš„**ç”Ÿå‘½å‘¨æœŸè¶…å‡ºçº¿ç¨‹æ‰§è¡Œå‘¨æœŸ**ã€‚
2. **æŒ‰å€¼æ•è·æœ€å®‰å…¨**ï¼šæŠŠæ‰€éœ€å¤–éƒ¨çŠ¶æ€æ‹·è´åˆ°é—­åŒ…å†…éƒ¨ã€‚
3. **ç§»åŠ¨æ•è·**ï¼ˆ`[p = std::move(p)]`ï¼‰å¯å®‰å…¨ä¼ é€’ç‹¬å èµ„æºã€‚
4. æ•è· `this` æ—¶ï¼Œä¼˜å…ˆä½¿ç”¨ `shared_from_this()` å»¶é•¿ç”Ÿå‘½å‘¨æœŸã€‚

> é€šè¿‡ä¸Šè¿°å…¨é¢æ¡ˆä¾‹ï¼Œè¯»è€…å¯ä»¥å…¨é¢ç†è§£å¹¶é¿å…å¤šçº¿ç¨‹ä¸­ lambda æ‚¬ç©ºå¼•ç”¨é£é™©ã€‚


ä½ è¯´å¾—å¯¹â€”â€”**å¯¹å¯ç§»åŠ¨çš„èµ„æº**ï¼ˆå¦‚ `std::unique_ptr`ã€`std::thread` æœ¬èº«ç­‰ï¼‰**å¯ä»¥åœ¨ lambda æ•è·æ—¶ç”¨ç§»åŠ¨è¯­ä¹‰**ï¼Œä»è€ŒæŠŠæ‰€æœ‰æƒè½¬è¿›é—­åŒ…ï¼Œé¿å…åŸå¯¹è±¡è¢«é”€æ¯åå˜æˆæ‚¬ç©ºã€‚ä½†è¦æ³¨æ„ä»¥ä¸‹å‡ ç‚¹ï¼š

---

## 1. ç§»åŠ¨æ•è·åªèƒ½è½¬ç§»æ‰€æœ‰æƒï¼Œä¸èƒ½å»¶é•¿ä»»æ„å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸ

```cpp
auto ptr = std::make_unique<Foo>();
std::thread t([ptr = std::move(ptr)]() {  // ptr çš„æ‰€æœ‰æƒè¢«â€œæ¬â€è¿›é—­åŒ…
    ptr->doWork();
});
t.join();
```

* è¿™é‡ŒåŸæ¥çš„ `ptr` è¢«ç§»åŠ¨ç©ºï¼ˆ`ptr == nullptr`ï¼‰ï¼Œé—­åŒ…é‡ŒæŒæœ‰äº†å®é™…èµ„æºï¼Œé¿å…äº†æ‚¬ç©ºã€‚
* **ä½†** å¦‚æœä½ å¯¹ä¸€ä¸ªæ ˆä¸Šå˜é‡åš `std::move`ï¼Œå®ƒåªæ˜¯æŠŠå®ƒâ€œæ ‡è®°â€ä¸ºå¯ç§»åŠ¨ï¼Œç„¶åæ‹·è´åˆ°é—­åŒ…é‡Œï¼›åŸæ ˆä¸Šå˜é‡è¿˜æ˜¯ä¼šåœ¨ç¦»å¼€ä½œç”¨åŸŸåé”€æ¯ï¼Œ**å¹¶ä¸ä¼šå› ä¸º std::move è€Œå»¶é•¿å…¶ç”Ÿå‘½å‘¨æœŸ**ã€‚

---

## 2. å¯¹äºæ™®é€šå€¼ç±»å‹ï¼ˆæ¯”å¦‚ `int`ã€`std::string`ã€å°å¯¹è±¡ï¼‰ï¼Œç§»åŠ¨ vs æ‹·è´æ„ä¹‰ä¸å¤§

```cpp
std::string s = "hello";
// copy-capture
auto t1 = std::thread([s]() { /* use s */ });
// move-capture
auto t2 = std::thread([s2 = std::move(s)]() { /* use s2 */ });
```

* å¯¹äº `std::string` è¿™ç±»å¤§å¯¹è±¡ï¼Œ`std::move` å¯ä»¥é¿å…ä¸€æ¬¡æ‹·è´ã€‚
* ä½†æ‹·è´æ•è·æœ¬èº«å°±ä¼šåœ¨é—­åŒ…é‡Œç”Ÿæˆä¸€ä»½è‡ªå·±çš„å‰¯æœ¬ï¼Œè¿™ä¸ªå‰¯æœ¬çš„ç”Ÿå‘½å‘¨æœŸç”±é—­åŒ…ï¼ˆå³çº¿ç¨‹ï¼‰æ§åˆ¶ï¼Œä¸ä¼šæ‚¬ç©ºã€‚

---

## 3. ç§»åŠ¨æ•è·æ— æ³•è§£å†³â€œå¼•ç”¨æ•è·â€çš„æ‚¬ç©ºé—®é¢˜

```cpp
int x = 42;
auto t = std::thread([&x]() { /* â€¦ */ });  // å¼•ç”¨æ•è·ï¼Œæ— è®ºä½ æ€ä¹ˆ std::moveï¼Œx éƒ½æ˜¯æ ˆä¸Šå˜é‡
```

* `std::move(x)` åªå¯¹å¯ç§»åŠ¨ç±»å‹æœ‰æ„ä¹‰ï¼Œå¯¹åŸç”Ÿ `int` ä¸ä¼šå»¶é•¿å…¶ç”Ÿå‘½å‘¨æœŸã€‚
* å¼•ç”¨æ•è·çš„é—®é¢˜ä¾æ—§è¦ç”¨ **æŒ‰å€¼æ•è·** æˆ– **æ™ºèƒ½æŒ‡é’ˆ** æ¥è§£å†³ã€‚

---

## 4. Lambda å¯¹è±¡æœ¬èº«çš„ç”Ÿå‘½å‘¨æœŸ

å³ä¾¿ä½ å¯¹æ•è·çš„èµ„æºéƒ½åšäº†ç§»åŠ¨ï¼Œ**ä¹Ÿè¦ä¿è¯ lambda å¯¹è±¡æœ¬èº«èƒ½æ´»åˆ°çº¿ç¨‹æ‰§è¡Œå®Œ**ã€‚
é€šå¸¸æˆ‘ä»¬æ˜¯è¿™æ ·å†™ï¼š

```cpp
std::thread t([res = std::move(res)](){
    /* use res */
});
t.join();  // join() å‰ï¼Œlambda è¿åŒå®ƒçš„æ•è·ä¸€èµ·éƒ½å­˜æ´»åœ¨ t å†…éƒ¨
```

* `std::thread` æ„é€ æ—¶\*\*æ‹·è´ï¼ˆæˆ–ç§»åŠ¨ï¼‰\*\*äº†è¿™ä¸ªé—­åŒ…å¯¹è±¡åˆ°è‡ªå·±çš„å†…éƒ¨å­˜å‚¨ã€‚
* åªè¦ä½  `join()`ï¼ˆæˆ– `detach()`ï¼‰å®ƒï¼Œé—­åŒ…å°±ä¼šåœ¨å­çº¿ç¨‹é‡Œå®Œæ•´æ‰§è¡Œã€‚

---

## 5. å°ç»“

1. **å¯¹ç‹¬å èµ„æºï¼ˆunique\_ptrã€socketã€æ–‡ä»¶å¥æŸ„ç­‰ï¼‰**ï¼Œç”¨ `[p = std::move(p)]` æŠŠæ‰€æœ‰æƒæ¬è¿›é—­åŒ…ï¼Œæ˜¯æœ€å®‰å…¨çš„åšæ³•ã€‚
2. **å¯¹æ™®é€šå€¼**ï¼Œç›´æ¥å€¼æ•è· `[x]` å°±èƒ½æ‹·è´ä¸€ä»½åˆ°é—­åŒ…ï¼Œç”Ÿå‘½å‘¨æœŸç”±çº¿ç¨‹æŒæœ‰ï¼Œæ— éœ€ç‰¹åˆ« â€œmoveâ€ã€‚
3. **æ°¸è¿œä¸è¦å¯¹æ ˆä¸Šå˜é‡ç”¨å¼•ç”¨æ•è·å†æŒ‡æœ› move èƒ½æ•‘åœº**â€”â€”å¼•ç”¨æ•è·çš„é—®é¢˜åªèƒ½ç”¨æŒ‰å€¼æ•è·æˆ–æ™ºèƒ½æŒ‡é’ˆæ¥å½»åº•è§£å†³ã€‚
4. **ä¿è¯ lambda å¯¹è±¡æœ¬èº«è¢«å­˜æ”¾ï¼ˆæ‹·è´/ç§»åŠ¨ï¼‰åˆ° `std::thread`**ï¼Œå¹¶åœ¨ `join()`/`detach()` å‰ä¸ä¸¢å¤±å®ƒã€‚

è¿™æ ·å°±æ—¢èƒ½åˆ©ç”¨ç§»åŠ¨è¯­ä¹‰ä¼˜åŒ–æ‹·è´å¼€é”€ï¼Œä¹Ÿèƒ½å½»åº•é¿å…æ‚¬ç©ºå¼•ç”¨çš„é—®é¢˜ã€‚
